<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Update Groups · EnsembleKalmanProcesses.jl</title><meta name="title" content="Update Groups · EnsembleKalmanProcesses.jl"/><meta property="og:title" content="Update Groups · EnsembleKalmanProcesses.jl"/><meta property="twitter:title" content="Update Groups · EnsembleKalmanProcesses.jl"/><meta name="description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="og:description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="twitter:description" content="Documentation for EnsembleKalmanProcesses.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="EnsembleKalmanProcesses.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">EnsembleKalmanProcesses.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation instructions</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../literated/sinusoid_example/">Simple example</a></li><li><a class="tocitem" href="../examples/Cloudy_example/">Cloudy</a></li><li><a class="tocitem" href="../examples/lorenz_example/">Lorenz</a></li><li><a class="tocitem" href="../literated/loss_minimization/">Minimization Loss</a></li><li><a class="tocitem" href="../literated/loss_minimization_sparse_eki/">Sparse Minimization Loss</a></li><li><a class="tocitem" href="../literated/aerosol_activation/">Aerosol activation</a></li><li><a class="tocitem" href="../examples/darcy/">Darcy flow</a></li><li><a class="tocitem" href="../examples/sinusoid_example_toml/">TOML interface</a></li><li><a class="tocitem" href="../examples/ClimateMachine_example/">HPC interfacing example: ClimateMachine</a></li><li><a class="tocitem" href="../examples/template_example/">Template</a></li></ul></li><li><a class="tocitem" href="../defaults/">List of default configurations</a></li><li><a class="tocitem" href="../ensemble_kalman_inversion/">Ensemble Kalman Inversion</a></li><li><a class="tocitem" href="../gauss_newton_kalman_inversion/">Gauss Newton Kalman Inversion</a></li><li><a class="tocitem" href="../ensemble_kalman_sampler/">Ensemble Kalman Sampler</a></li><li><a class="tocitem" href="../unscented_kalman_inversion/">Unscented Kalman Inversion</a></li><li><a class="tocitem" href="../learning_rate_scheduler/">Learning rate schedulers</a></li><li><a class="tocitem" href="../parameter_distributions/">Prior distributions</a></li><li><a class="tocitem" href="../observations/">Observations and Minibatching</a></li><li class="is-active"><a class="tocitem" href>Update Groups</a><ul class="internal"><li><a class="tocitem" href="#Recommended-construction-shown-by-example"><span>Recommended construction - shown by example</span></a></li><li><a class="tocitem" href="#What-happens-internally?"><span>What happens internally?</span></a></li><li><a class="tocitem" href="#Advice-for-constructing-blocks"><span>Advice for constructing blocks</span></a></li></ul></li><li><a class="tocitem" href="../localization/">Localization and SEC</a></li><li><a class="tocitem" href="../accelerators/">Accelerators</a></li><li><a class="tocitem" href="../inflation/">Inflation</a></li><li><a class="tocitem" href="../parallel_hpc/">Parallelism and HPC</a></li><li><a class="tocitem" href="../internal_data_representation/">Internal data representation</a></li><li><a class="tocitem" href="../troubleshooting/">Troubleshooting</a></li><li><input class="collapse-toggle" id="menuitem-19" type="checkbox"/><label class="tocitem" for="menuitem-19"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../API/ParameterDistributions/">ParameterDistributions</a></li><li><a class="tocitem" href="../API/Observations/">Observations</a></li><li><a class="tocitem" href="../API/DataContainers/">DataContainers</a></li><li><a class="tocitem" href="../API/EnsembleKalmanProcess/">EnsembleKalmanProcess</a></li><li><a class="tocitem" href="../API/Inversion/">Inversion</a></li><li><a class="tocitem" href="../API/Unscented/">Unscented</a></li><li><a class="tocitem" href="../API/Sampler/">Sampler</a></li><li><a class="tocitem" href="../API/SparseInversion/">SparseInversion</a></li><li><a class="tocitem" href="../API/TOMLInterface/">TOML Interface</a></li><li><a class="tocitem" href="../API/Localizers/">Localizers</a></li></ul></li><li><a class="tocitem" href="../contributing/">Contributing</a></li><li><a class="tocitem" href="../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Update Groups</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Update Groups</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/main/docs/src/update_groups.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="update-groups"><a class="docs-heading-anchor" href="#update-groups">Update Groups</a><a id="update-groups-1"></a><a class="docs-heading-anchor-permalink" href="#update-groups" title="Permalink"></a></h1><p>The <code>UpdateGroup</code> object facilitates blocked EKP updates, based on a provided updating a series user-defined pairs of parameters and data. This allows users to enforce any <em>known</em> (in)dependences between different groups of parameters during the update. For example, </p><pre><code class="language-julia hljs"># update parameter 1 with data 1 and 2
# update parameters 2 and 3 jointly with data 2, 3, and 4
Dict(
    [&quot;parameter_1&quot;] =&gt; [&quot;data_1&quot;, &quot;data_2&quot;], 
    [&quot;parameter_2&quot;, &quot;parameter_3&quot;] =&gt; [&quot;data_2&quot;, &quot;data_3&quot;, &quot;data_4&quot;], 
)</code></pre><p>Construction and passing of this into the EnsembleKalmanProcesses is detailed below.</p><div class="admonition is-info"><header class="admonition-header">This improves scaling at the cost of user-imposed structure</header><div class="admonition-body"><p>As many of the <code>Process</code> updates scale say with <span>$d^\alpha$</span>, in the data dimension <span>$d$</span> and <span>$\alpha &gt; 1$</span> (super-linearly),  update groups with <span>$K$</span> groups of equal size will improving this scaling to <span>$K (\frac{d}{K})^\alpha$</span>.</p></div></div><h2 id="Recommended-construction-shown-by-example"><a class="docs-heading-anchor" href="#Recommended-construction-shown-by-example">Recommended construction - shown by example</a><a id="Recommended-construction-shown-by-example-1"></a><a class="docs-heading-anchor-permalink" href="#Recommended-construction-shown-by-example" title="Permalink"></a></h2><p>The key component to construct update groups starts with constructing the prior and the observations. Parameter distributions and observations may be constructed in units and given names, and these names are utilized to build the update groups with a convenient constructor <code>create_update_groups</code>.</p><p>For illustration, we take code snippets from the example found <a href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/main/examples/UpdateGroups/">here</a>. This example is concerned with learning several parameters in a coupled two-scale Lorenz 96 system:</p><p class="math-container">\[\begin{aligned}
 \frac{\partial X_i}{\partial t} &amp; = -X_{i-1}(X_{i-2} - X_{i+1}) - X_i - GY_i + F_1 + F_2\,\sin(2\pi t F_3)\\
 \frac{\partial Y_i}{\partial t} &amp; = -cbY_{i+1}(Y_{i+2} - Y_{i-1}) - cY_i + \frac{hc}{b} X_i 
\end{aligned}\]</p><p>Parameters are learnt by fitting estimated moments of a realized <code>X</code> and <code>Y</code> system, to some target moments over a time interval.</p><p>We create a prior by combining several <em>named</em> <code>ParameterDistribution</code>s.</p><pre><code class="language-julia hljs">param_names = [&quot;F&quot;, &quot;G&quot;, &quot;h&quot;, &quot;c&quot;, &quot;b&quot;]

prior_F = ParameterDistribution(
    Dict(
        &quot;name&quot; =&gt; param_names[1],
        &quot;distribution&quot; =&gt; Parameterized(MvNormal([1.0, 0.0, -2.0], I)),
        &quot;constraint&quot; =&gt; repeat([bounded_below(0)], 3),
    ),
) # gives 3-D dist
prior_G = constrained_gaussian(param_names[2], 5.0, 4.0, 0, Inf)
prior_h = constrained_gaussian(param_names[3], 5.0, 4.0, 0, Inf)
prior_c = constrained_gaussian(param_names[4], 5.0, 4.0, 0, Inf)
prior_b = constrained_gaussian(param_names[5], 5.0, 4.0, 0, Inf)
priors = combine_distributions([prior_F, prior_G, prior_h, prior_c, prior_b])</code></pre><p>Now we likewise construct observed moments by combining several <em>named</em> <code>Observation</code>s</p><pre><code class="language-julia hljs"># given a list of vector statistics y and their covariances Γ 
data_block_names = [&quot;&lt;X&gt;&quot;, &quot;&lt;Y&gt;&quot;, &quot;&lt;X^2&gt;&quot;, &quot;&lt;Y^2&gt;&quot;, &quot;&lt;XY&gt;&quot;]

observation_vec = []
for i in 1:length(data_block_names)
    push!(
        observation_vec,
        Observation(Dict(
            &quot;samples&quot; =&gt; y[i],
            &quot;covariances&quot; =&gt; Γ[i],
            &quot;names&quot; =&gt; data_block_names[i]
        )),
    )
end
observation = combine_observations(observation_vec)</code></pre><p>Finally, we are ready to define the update groups. We may specify our choice by partitioning the parameter names as keys of a dictionary, and their paired data names as values. Here we create two groups:</p><pre><code class="language-julia hljs"># update parameters F,G with data &lt;X&gt;, &lt;X^2&gt;, &lt;XY&gt;
# update parameters h, c, b with data &lt;Y&gt;, &lt;Y^2&gt;, &lt;XY&gt;
group_identifiers = Dict(
    [&quot;F&quot;, &quot;G&quot;] =&gt; [&quot;&lt;X&gt;&quot;, &quot;&lt;X^2&gt;&quot;, &quot;&lt;XY&gt;&quot;],
    [&quot;h&quot;, &quot;c&quot;, &quot;b&quot;] =&gt; [&quot;&lt;Y&gt;&quot;, &quot;&lt;Y^2&gt;&quot;, &quot;&lt;XY&gt;&quot;],
)</code></pre><p>We then create the update groups with our convenient constructor</p><pre><code class="language-julia hljs">update_groups = create_update_groups(prior, observation, group_identifiers)</code></pre><p>and this can then be entered into the <code>EnsembleKalmanProcess</code> object as a keyword argument</p><pre><code class="language-julia hljs"># initial_params = construct_initial_ensemble(rng, priors, N_ens) 
ekiobj = EnsembleKalmanProcess(
    initial_params,
    observation,
    Inversion(),
    update_groups = update_groups
)</code></pre><h2 id="What-happens-internally?"><a class="docs-heading-anchor" href="#What-happens-internally?">What happens internally?</a><a id="What-happens-internally?-1"></a><a class="docs-heading-anchor-permalink" href="#What-happens-internally?" title="Permalink"></a></h2><p>We simply perform an independent <code>update_ensemble!</code> for each provided pairing and combine model output and updated parameters afterwards. Note that even without specifying an update group, by default EKP will always be construct one under-the-hood.</p><h2 id="Advice-for-constructing-blocks"><a class="docs-heading-anchor" href="#Advice-for-constructing-blocks">Advice for constructing blocks</a><a id="Advice-for-constructing-blocks-1"></a><a class="docs-heading-anchor-permalink" href="#Advice-for-constructing-blocks" title="Permalink"></a></h2><ol><li>A parameter cannot appear in more than one block (i.e. parameters cannot be updated more than once)</li><li>The block structure is user-defined, and directly assumes that there is no correlation between blocks. It is up to the user to confirm if there truly is independence between different blocks. Otherwise convergence properties may suffer.</li><li>This can be used in conjunction with minibatching, so long as the defined data objects are available in all <code>Observation</code>s in the series.</li></ol><div class="admonition is-info"><header class="admonition-header">In future...</header><div class="admonition-body"><p>In theory this opens up the possibility to have different configurations, or even processes, in different groups. This could be useful when parameter-data pairings are highly heterogeneous and so the user may wish to exploit, for example, the different processes scaling properties. However this has not yet been implemented.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../observations/">« Observations and Minibatching</a><a class="docs-footer-nextpage" href="../localization/">Localization and SEC »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.1 on <span class="colophon-date" title="Tuesday 11 March 2025 21:14">Tuesday 11 March 2025</span>. Using Julia version 1.11.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
