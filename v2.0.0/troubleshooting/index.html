<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Troubleshooting · EnsembleKalmanProcesses.jl</title><meta name="title" content="Troubleshooting · EnsembleKalmanProcesses.jl"/><meta property="og:title" content="Troubleshooting · EnsembleKalmanProcesses.jl"/><meta property="twitter:title" content="Troubleshooting · EnsembleKalmanProcesses.jl"/><meta name="description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="og:description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="twitter:description" content="Documentation for EnsembleKalmanProcesses.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="EnsembleKalmanProcesses.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">EnsembleKalmanProcesses.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation instructions</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../literated/sinusoid_example/">Simple example</a></li><li><a class="tocitem" href="../examples/Cloudy_example/">Cloudy</a></li><li><a class="tocitem" href="../examples/lorenz_example/">Lorenz</a></li><li><a class="tocitem" href="../literated/loss_minimization/">Minimization Loss</a></li><li><a class="tocitem" href="../literated/loss_minimization_sparse_eki/">Sparse Minimization Loss</a></li><li><a class="tocitem" href="../literated/aerosol_activation/">Aerosol activation</a></li><li><a class="tocitem" href="../examples/darcy/">Darcy flow</a></li><li><a class="tocitem" href="../examples/sinusoid_example_toml/">TOML interface</a></li><li><a class="tocitem" href="../examples/ClimateMachine_example/">HPC interfacing example: ClimateMachine</a></li><li><a class="tocitem" href="../examples/template_example/">Template</a></li></ul></li><li><a class="tocitem" href="../defaults/">List of default configurations</a></li><li><a class="tocitem" href="../ensemble_kalman_inversion/">Ensemble Kalman Inversion</a></li><li><a class="tocitem" href="../ensemble_kalman_sampler/">Ensemble Kalman Sampler</a></li><li><a class="tocitem" href="../unscented_kalman_inversion/">Unscented Kalman Inversion</a></li><li><a class="tocitem" href="../learning_rate_scheduler/">Learning rate schedulers</a></li><li><a class="tocitem" href="../parameter_distributions/">Prior distributions</a></li><li><a class="tocitem" href="../observations/">Observations and Minibatching</a></li><li><a class="tocitem" href="../localization/">Localization and SEC</a></li><li><a class="tocitem" href="../inflation/">Inflation</a></li><li><a class="tocitem" href="../parallel_hpc/">Parallelism and HPC</a></li><li><a class="tocitem" href="../internal_data_representation/">Internal data representation</a></li><li class="is-active"><a class="tocitem" href>Troubleshooting</a><ul class="internal"><li><a class="tocitem" href="#High-failure-rate"><span>High failure rate</span></a></li><li><a class="tocitem" href="#Loss-does-not-converge-or-final-fits-are-inadequate"><span>Loss does not converge or final fits are inadequate</span></a></li><li><a class="tocitem" href="#I-have-a-model-\\Psi.-But-how-do-I-design-my-forward-map-G?"><span>I have a model <span>$\Psi$</span>. But how do I design my forward map G?</span></a></li><li><a class="tocitem" href="#common-messages"><span>Common warning/error messages</span></a></li></ul></li><li><input class="collapse-toggle" id="menuitem-16" type="checkbox"/><label class="tocitem" for="menuitem-16"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../API/ParameterDistributions/">ParameterDistributions</a></li><li><a class="tocitem" href="../API/Observations/">Observations</a></li><li><a class="tocitem" href="../API/DataContainers/">DataContainers</a></li><li><a class="tocitem" href="../API/EnsembleKalmanProcess/">EnsembleKalmanProcess</a></li><li><a class="tocitem" href="../API/Inversion/">Inversion</a></li><li><a class="tocitem" href="../API/Unscented/">Unscented</a></li><li><a class="tocitem" href="../API/Sampler/">Sampler</a></li><li><a class="tocitem" href="../API/SparseInversion/">SparseInversion</a></li><li><a class="tocitem" href="../API/TOMLInterface/">TOML Interface</a></li><li><a class="tocitem" href="../API/Localizers/">Localizers</a></li></ul></li><li><a class="tocitem" href="../contributing/">Contributing</a></li><li><a class="tocitem" href="../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Troubleshooting</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Troubleshooting</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/main/docs/src/troubleshooting.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="troubleshooting"><a class="docs-heading-anchor" href="#troubleshooting">Troubleshooting and Workflow Tips</a><a id="troubleshooting-1"></a><a class="docs-heading-anchor-permalink" href="#troubleshooting" title="Permalink"></a></h1><h2 id="High-failure-rate"><a class="docs-heading-anchor" href="#High-failure-rate">High failure rate</a><a id="High-failure-rate-1"></a><a class="docs-heading-anchor-permalink" href="#High-failure-rate" title="Permalink"></a></h2><p>While some EKI variants include failure handlers, excessively high failure rates (i.e., &gt; 80%) can lead to inversions finding local minima or failing to converge. To address this:</p><ul><li><strong>Stabilize the Forward Model</strong>: Ensure the forward model remains stable for small parameter perturbations in offline tests. If the forward model is unstable for most of the parameter space, it is challenging to explore it with a calibration method.</li><li><strong>Adjust Priors</strong>: Reduce the uncertainty in priors. Priors with large variances can lead to forward evaluations that deviate significantly from the known prior means, increasing the likelihood of failures.</li><li><strong>Increase Ensemble Size</strong>: Without <a href="../localization/#localization">localization</a> or other methods that break the subspace property, the ensemble size should generally exceed the number of parameters being optimized. The ensemble size needs to be large enough to ensure a sufficient number of successful runs, given the failure rate.</li><li><strong>Consider a Preconditioner</strong>: While not currently a native feature in EKP, consider using a preconditioning method to find stable parameter pairs before the first iteration. A preconditioner, applied in each ensemble member, recursively draws from the prior distribution until a stable parameter pair is achieved. The successful parameter pairs serve as the parameter values for the first iteration. Depending on the stability of the forward model,this may need to be as high as 5-10 retries.</li><li><strong>Implement Parameter Inflation</strong>: High failure rates in the initial iterations can lead to rapid collapse of ensemble members. Prevent the ensemble from collapsing prematurely by adding parameter inflation. For more, see <a href="../inflation/#inflation">inflation</a></li></ul><h2 id="Loss-does-not-converge-or-final-fits-are-inadequate"><a class="docs-heading-anchor" href="#Loss-does-not-converge-or-final-fits-are-inadequate">Loss does not converge or final fits are inadequate</a><a id="Loss-does-not-converge-or-final-fits-are-inadequate-1"></a><a class="docs-heading-anchor-permalink" href="#Loss-does-not-converge-or-final-fits-are-inadequate" title="Permalink"></a></h2><p>If either the loss decreases too slowly/diverges or the final fits appear inadequate:</p><ul><li><strong>Check Observation Noise in Data Space</strong>: Ensure that noise estimates are realistic and consistent across variables with different dimensions and variability characteristics. Observation noise that is unrealistically large for a given variable or data point may prevent convergence to solutions that closely fit the data. Carefully base noise estimates on empirical data or domain knowledge, and try reducing noise if the previous suggestions don’t work. This is especially common if using <span>$\sigma^2 * I$</span> as artificial noise. Even if <span>$u$</span> appears incorrect, it is advisable to examine the graphs of <span>$G(u)$</span> compared to  <span>$y \pm 2\sigma$</span> to determine if the forward map lies within the noise level. If it does, further convergence cannot be achieved without reducing the noise or altering the loss function.</li><li><strong>Check for Failures</strong>: Refer to the suggestions for handling a high failure rate.</li><li><strong>Adjust the Artificial Timestep</strong>: For indirect learning problems involving neural networks, larger timesteps [O(10)] are generally more effective and using variable timesteppers (e.g., <code>DataMisfitController()</code>) tends to yield the best results. For scheduler options, see <a href="../learning_rate_scheduler/#learning-rate-schedulers">scheduler</a> docs.</li><li><strong>If Batching, Increase Batch Size</strong>: While not natively implemented within the EKP package, users employing mini-batching (using subsamples of the full dataset in each EKI iteration) should consider modifying the batch size. If the loss is too noisy and convergence is slow, consider increasing the batch size. See <a href="../inflation/#inflation">inflation</a> if using mini-batching with inflation. </li><li><strong>Reevaluate Loss Function</strong>: Consider exploring alternative loss functions with different variables.</li><li><strong>Structural Model Errors</strong>: If these troubleshooting tips do not work, remaining discrepancies might suggest inherent structural errors between the model and the data, which could lead to trade-offs in parameter estimation. Modifications may be needed to the underlying forward model. </li></ul><h2 id="I-have-a-model-\\Psi.-But-how-do-I-design-my-forward-map-G?"><a class="docs-heading-anchor" href="#I-have-a-model-\\Psi.-But-how-do-I-design-my-forward-map-G?">I have a model <span>$\Psi$</span>. But how do I design my forward map G?</a><a id="I-have-a-model-\\Psi.-But-how-do-I-design-my-forward-map-G?-1"></a><a class="docs-heading-anchor-permalink" href="#I-have-a-model-\\Psi.-But-how-do-I-design-my-forward-map-G?" title="Permalink"></a></h2><ul><li>Ensure prior means are chosen appropriately, and that any hard <a href="../parameter_distributions/#parameter-distributions">constraints</a> (i.e., parameter values must be positive) are enforced.</li><li>Start with a perfect model experiment, where an attempt is made to recover known parameter values in <span>$\Psi$</span> through calibration, to learn about what outputs from <span>$\Psi$</span> are sensitive to the parameters.</li><li>For time-evolving systems, consider aggregating data through spatial or temporal averaging, rather than using the full timeseries. </li><li>Find out which observational data are available for the problem at hand, and what observational noise is provided for measuring instruments.</li></ul><h2 id="common-messages"><a class="docs-heading-anchor" href="#common-messages">Common warning/error messages</a><a id="common-messages-1"></a><a class="docs-heading-anchor-permalink" href="#common-messages" title="Permalink"></a></h2><ul><li><pre><code class="language-julia hljs">Info: &quot;Termination condition of scheduler `DataMisfitController` will be exceeded during the next iteration.&quot;
Warning: Termination condition of scheduler `DataMisfitController` has been exceeded, returning `true` from `update_ensemble!` and preventing futher updates. Set on_terminate=&quot;continue&quot; in `DataMisfitController` to ignore termination</code></pre></li></ul><p>The <code>DataMisfitController</code> is an adaptive scheduler that can terminate the algorithm at a given value of algorithm time (rather than juat a given number of iterations). See <a href="../learning_rate_scheduler/#learning-rate-schedulers">here</a> for details on changing the termination condition. Or how to handle this in your iteration loop.</p><ul><li><pre><code class="language-julia hljs">Warning: Acceleration is experimental for Sampler processes and may affect convergence.</code></pre></li></ul><p>This is found when providing something other than <code>accelerator = DefaultAccelerator()</code> in EKS.</p><ul><li><pre><code class="language-julia hljs">Info: 1 particle failure(s) detected. Handler used: IgnoreFailures.
Info: 1 particle failure(s) detected. Handler used: SampleSuccGauss.</code></pre></li></ul><p>Both these messages arise when the EKP <code>update_ensemble!</code> has detected <code>NaN</code>s in the forward map evaluation array. One can choose how to handle failed ensemble members with the EKP keyword <code>failure_handler_method</code> for more information on the failure handling methods see <a href="../ensemble_kalman_inversion/#failure-eki">here for EKI/ETKI/SEKI</a> or <a href="../unscented_kalman_inversion/#failure-uki">here for UKI</a>. Note that EKS does not yet have a consistent failure handler method.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../internal_data_representation/">« Internal data representation</a><a class="docs-footer-nextpage" href="../API/ParameterDistributions/">ParameterDistributions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.6.0 on <span class="colophon-date" title="Thursday 29 August 2024 21:28">Thursday 29 August 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
