<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Failure handling · EnsembleKalmanProcesses.jl</title><meta name="title" content="Failure handling · EnsembleKalmanProcesses.jl"/><meta property="og:title" content="Failure handling · EnsembleKalmanProcesses.jl"/><meta property="twitter:title" content="Failure handling · EnsembleKalmanProcesses.jl"/><meta name="description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="og:description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="twitter:description" content="Documentation for EnsembleKalmanProcesses.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="EnsembleKalmanProcesses.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">EnsembleKalmanProcesses.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation instructions</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../literated/sinusoid_example/">Simple example</a></li><li><a class="tocitem" href="../examples/Cloudy_example/">Cloudy</a></li><li><a class="tocitem" href="../examples/lorenz_example/">Lorenz</a></li><li><a class="tocitem" href="../literated/loss_minimization/">Minimization Loss</a></li><li><a class="tocitem" href="../literated/loss_minimization_sparse_eki/">Sparse Minimization Loss</a></li><li><a class="tocitem" href="../literated/aerosol_activation/">Aerosol activation</a></li><li><a class="tocitem" href="../examples/darcy/">Darcy flow</a></li><li><a class="tocitem" href="../examples/sinusoid_example_toml/">TOML interface</a></li><li><a class="tocitem" href="../examples/ClimateMachine_example/">HPC interfacing example: ClimateMachine</a></li><li><a class="tocitem" href="../examples/template_example/">Template</a></li></ul></li><li><a class="tocitem" href="../defaults/">List of default configurations</a></li><li><a class="tocitem" href="../ensemble_kalman_inversion/">Ensemble Kalman Inversion</a></li><li><a class="tocitem" href="../gauss_newton_kalman_inversion/">Gauss Newton Kalman Inversion</a></li><li><a class="tocitem" href="../ensemble_kalman_sampler/">Ensemble Kalman Sampler</a></li><li><a class="tocitem" href="../unscented_kalman_inversion/">Unscented Kalman Inversion</a></li><li><a class="tocitem" href="../learning_rate_scheduler/">Learning rate schedulers</a></li><li><a class="tocitem" href="../parameter_distributions/">Prior distributions</a></li><li><a class="tocitem" href="../observations/">Observations and Minibatching</a></li><li><a class="tocitem" href="../update_groups/">Update Groups</a></li><li><a class="tocitem" href="../localization/">Localization and SEC</a></li><li><a class="tocitem" href="../accelerators/">Accelerators</a></li><li><a class="tocitem" href="../inflation/">Inflation</a></li><li class="is-active"><a class="tocitem" href>Failure handling</a><ul class="internal"><li><a class="tocitem" href="#failures"><span>Handling forward model failures</span></a></li><li><a class="tocitem" href="#Implementation"><span>Implementation</span></a></li><li><a class="tocitem" href="#When-has-a-particle-&quot;failed&quot;?"><span>When has a particle &quot;failed&quot;?</span></a></li></ul></li><li><a class="tocitem" href="../parallel_hpc/">Parallelism and HPC</a></li><li><a class="tocitem" href="../internal_data_representation/">Internal data representation</a></li><li><a class="tocitem" href="../visualization/">Visualization</a></li><li><a class="tocitem" href="../troubleshooting/">Troubleshooting</a></li><li><input class="collapse-toggle" id="menuitem-21" type="checkbox"/><label class="tocitem" for="menuitem-21"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../API/ParameterDistributions/">ParameterDistributions</a></li><li><a class="tocitem" href="../API/Observations/">Observations</a></li><li><a class="tocitem" href="../API/DataContainers/">DataContainers</a></li><li><a class="tocitem" href="../API/EnsembleKalmanProcess/">EnsembleKalmanProcess</a></li><li><a class="tocitem" href="../API/Inversion/">Inversion</a></li><li><a class="tocitem" href="../API/Unscented/">Unscented</a></li><li><a class="tocitem" href="../API/Sampler/">Sampler</a></li><li><a class="tocitem" href="../API/SparseInversion/">SparseInversion</a></li><li><a class="tocitem" href="../API/TOMLInterface/">TOML Interface</a></li><li><a class="tocitem" href="../API/Localizers/">Localizers</a></li><li><a class="tocitem" href="../API/Visualize/">Visualize</a></li></ul></li><li><a class="tocitem" href="../contributing/">Contributing</a></li><li><a class="tocitem" href="../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Failure handling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Failure handling</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/main/docs/src/failure_handling.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h2 id="failures"><a class="docs-heading-anchor" href="#failures">Handling forward model failures</a><a id="failures-1"></a><a class="docs-heading-anchor-permalink" href="#failures" title="Permalink"></a></h2><p>In situations where the forward model <span>$\mathcal{G}$</span> represents a diagnostic of a complex computational model, there might be cases where for some parameter combinations <span>$\theta$</span>, attempting to evaluate <span>$\mathcal{G}(\theta)$</span> may result in model failure. Some examples could be</p><ol><li>A member is numerically unstable, or throws error exceptions</li><li>A member exceeds a user-defined wall-clock time for computation</li><li>A member&#39;s outputs produce (full or partial) values that are user-defined as &quot;failure&quot;</li><li>Possible corruption of data or compute nodes during HPC model evaluation</li></ol><p>In such cases, this package offers the option for users to replace entries in the evaluation with <code>NaN</code> values, and then updates will continue with the following procedures</p><ul><li>Imputation: If only partial output of an ensemble member is <code>NaN</code>, then values may be redeemed with values derived from other ensemble members, or from user-defined values. Imputed members will be considered successful.</li><li>Failure handling: The update equations are then modified to handle/replace/resample failed members. Crucially, this is done in a way that does not break parallelism (i.e., no re-running of failed members)</li></ul><p><code>EnsembleKalmanProcesses.jl</code> implements such modifications through the <code>FailureHandler</code> structure, an input to the <code>EnsembleKalmanProcess</code> constructor. Currently, the only failsafe modification available is <code>SampleSuccGauss()</code>, described in <a href="https://doi.org/10.1029/2022MS003105">Lopez-Gomez et al (2022)</a>.</p><div class="admonition is-warning" id="These-are-last-resort-handlers-db7450a82fd0597c"><header class="admonition-header">These are last-resort handlers<a class="admonition-anchor" href="#These-are-last-resort-handlers-db7450a82fd0597c" title="Permalink"></a></header><div class="admonition-body"><p>These modifications are not a magic bullet. If large fractions of ensemble members fail during an iteration, this will degenerate the span of the ensemble, as one may not be able to replace lost information.</p></div></div><h2 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h2><p>When available, the failure handling and imputation is active by default, see <a href="../defaults/#defaults">here</a> for the different options. Alternatively, one can use the <code>failure_handler_method</code> keyword</p><pre><code class="language-julia hljs">using EnsembleKalmanProcesses
using EnsembleKalmanProcesses.ParameterDistributions


# for e.g., EKI
J = 50  # number of ensemble members
initial_ensemble = construct_initial_ensemble(prior, J) # Initialize ensemble from prior
ekiobj = EnsembleKalmanProcess(
    initial_ensemble,
    y,
    obs_noise_cov,
    Inversion(),
    failure_handler_method = SampleSuccGauss())

# for e.g., UKI
ukiobj = EnsembleKalmanProcess(
    y
    obs_noise_cov,
    Unscented(prior),
    failure_handler_method = SampleSuccGauss())</code></pre><h2 id="When-has-a-particle-&quot;failed&quot;?"><a class="docs-heading-anchor" href="#When-has-a-particle-&quot;failed&quot;?">When has a particle &quot;failed&quot;?</a><a id="When-has-a-particle-&quot;failed&quot;?-1"></a><a class="docs-heading-anchor-permalink" href="#When-has-a-particle-&quot;failed&quot;?" title="Permalink"></a></h2><h3 id="Full-particle-failure"><a class="docs-heading-anchor" href="#Full-particle-failure">Full particle failure</a><a id="Full-particle-failure-1"></a><a class="docs-heading-anchor-permalink" href="#Full-particle-failure" title="Permalink"></a></h3><p>The user determines if a ensemble member has failed and replace the output (column) of <span>$\mathcal{G}(\theta)$</span> with <code>NaN</code>s. The <code>FailureHandler</code> takes care of the rest.</p><h3 id="Partial-particle-failure-(a.k.a-Imputation)"><a class="docs-heading-anchor" href="#Partial-particle-failure-(a.k.a-Imputation)">Partial particle failure (a.k.a Imputation)</a><a id="Partial-particle-failure-(a.k.a-Imputation)-1"></a><a class="docs-heading-anchor-permalink" href="#Partial-particle-failure-(a.k.a-Imputation)" title="Permalink"></a></h3><p>If there is a partial failure within an output then the user sets only failed entries within a particle to <code>NaN</code>. The user can then use two keywords to determine the imputation approach, given to <code>EnsembleKalmanProcess</code>.</p><ul><li><code>nan_tolerance</code>: If the number of <code>NaN</code>s in any observation is below a given <code>nan_tolerance</code> (default 10%) then the particle will still be considered successful (not handled by the <code>FailureHandler</code>) and the algorithm will impute <code>NaN</code>s using information from other ensemble members or user-defined values.</li><li><code>nan_rows_value</code>: if the same entry fails for all ensemble members, then imputing is not possible without additional information; here the user may supply a vector with the dimension of the output and this value will be imputed for all members in this row.</li></ul><h3 id="Example-of-Imputation-and-Failure-Handling"><a class="docs-heading-anchor" href="#Example-of-Imputation-and-Failure-Handling">Example of Imputation and Failure Handling</a><a id="Example-of-Imputation-and-Failure-Handling-1"></a><a class="docs-heading-anchor-permalink" href="#Example-of-Imputation-and-Failure-Handling" title="Permalink"></a></h3><p>For example imagine we have a 7-dimensional output and 4 ensemble members. The latest run produces</p><pre><code class="language-julia hljs">g = 
7×4 Matrix{Float64}:
NaN           0.992373   NaN           -0.200025
-1.37133     0.0527899  NaN           -1.15243
NaN         NaN          NaN          NaN
NaN         NaN          NaN          NaN
-2.28799   NaN            0.614214     1.54217
0.582582    0.0744582   -1.37219      0.253971
0.620447    0.441834     0.0641471    0.490588</code></pre><p>Now, given the user-defined settings in <code>EnsembleKalmanProcess(...)</code></p><pre><code class="language-julia hljs">nan_tolerance = 0.5         # failure if &gt; 50% NaN
nan_rows_value = collect(1:7) # replace failed row k with value k</code></pre><p>The imputation will produce:</p><pre><code class="language-julia hljs">┌ Warning: In forward map ensemble g, detected 12 NaNs. 
│ Given nan_tolerance = 0.5 to determine failed members: 
│ - Ensemble members failed:       1 
│ - NaNs in successful members:    8 
│ - rows index set for imputation: [1, 3, 4, 5] 
│ - rows index entirely NaN:       [3, 4]
[ Info: Imputed 8 NaNs
7×4 Matrix{Float64}:
0.396174   0.992373   NaN          -0.200025     # `g[1, 1]`        -&gt; `mean(g[1, [2, 4] ])`
-1.37133    0.0527899  NaN          -1.15243
3.0        3.0        NaN           3.0          # `g[3, [1, 2, 4]]`-&gt; `3.0`
4.0        4.0        NaN           4.0          # `g[4, [1, 2, 4]]`-&gt; `4.0`
-2.28799   -0.0438687    0.614214    1.54217     # `g[5, 2]`        -&gt; `mean(g[5, [1, 3, 4])`
0.582582   0.0744582   -1.37219     0.253971
0.620447   0.441834     0.0641471   0.490588</code></pre><p>Here,</p><ul><li>A warning is given to describe the context</li><li>member 3 was deemed a failure(&gt;50% NaN) and will be replaced with the failure handler, <code>SampleSuccGauss</code> during EKP update</li><li>members 1, 2, and 4 were deemed successful, and so are imputed with values for the EKP update.</li></ul><h3 id="failure-eki"><a class="docs-heading-anchor" href="#failure-eki"><code>SampleSuccGauss()</code> for EKI</a><a id="failure-eki-1"></a><a class="docs-heading-anchor-permalink" href="#failure-eki" title="Permalink"></a></h3><p>The <code>SampleSuccGauss()</code> modification is based on updating all ensemble members with a distribution given by only the successful parameter ensemble. Let <span>$\Theta_{s,n}=[ \theta^{(1)}_{s,n},\dots,\theta^{(J_s)}_{s,n}]$</span> be the successful ensemble, for which each evaluation <span>$\mathcal{G}(\theta^{(j)}_{s,n})$</span> does not fail, and let <span>$\theta_{f,n}^{(k)}$</span> be the ensemble members for which the evaluation <span>$\mathcal{G}(\theta^{(k)}_{f,n})$</span> fails. The successful ensemble <span>$\Theta_{s,n}$</span> is updated to <span>$\Theta_{s,n+1}$</span> using expression (2), and each failed ensemble member as</p><p class="math-container">\[    \theta_{f,n+1}^{(k)} \sim \mathcal{N} \left({m}_{s, {n+1}}, \Sigma_{s, n+1} \right),\]</p><p>where</p><p class="math-container">\[    {m}_{s, {n+1}} = \dfrac{1}{J_s}\sum_{j=1}^{J_s} \theta_{s,n+1}^{(j)}, \qquad \Sigma_{s, n+1} = \mathrm{Cov}(\theta_{s, n+1}, \theta_{s, n+1}) + \kappa_*^{-1}\mu_{s,1}I_p.\]</p><p>Here, <span>$\kappa_*$</span> is a limiting condition number, <span>$\mu_{s,1}$</span> is the largest eigenvalue of the sample covariance <span>$\mathrm{Cov}(\theta_{s, n+1}, \theta_{s, n+1})$</span> and <span>$I_p$</span> is the identity matrix of size <span>$p\times p$</span>.</p><h3 id="failure-uki"><a class="docs-heading-anchor" href="#failure-uki"><code>SampleSuccGauss()</code> for UKI</a><a id="failure-uki-1"></a><a class="docs-heading-anchor-permalink" href="#failure-uki" title="Permalink"></a></h3><p>The <code>SampleSuccGauss()</code> modification is based on performing the UKI quadratures over the successful sigma points. Consider the set of off-center sigma points <span>$\{\hat{\theta}\} = \{\hat{\theta}_s\} \cup \{\hat{\theta}_f\}$</span> where <span>$\hat{\theta}_{s}^{(j)}$</span>,  <span>$j=1, \dots, J_s$</span> are successful members and <span>$\hat{\theta}_{f}^{(k)}$</span> are not. For ease of notation, consider an ordering of <span>$\{\hat{\theta}\}$</span> such that <span>$\{\hat{\theta}_s\}$</span> are its first <span>$J_s$</span> elements, and note that we deal with the central point <span>$\hat{\theta}^{(0)}$</span> separately. We estimate the covariances <span>$\mathrm{Cov}_q(\mathcal{G}_n, \mathcal{G}_n)$</span> and <span>$\mathrm{Cov}_q(\theta_{n}, \mathcal{G}_n)$</span> from the successful ensemble,</p><p class="math-container">\[   \tag{1} \mathrm{Cov}_q(\theta_n, \mathcal{G}_n) \approx \sum_{j=1}^{J_s}w_{s,j} (\hat{\theta}_{s, n}^{(j)} - \bar{\theta}_{s,n})(\mathcal{G}(\hat{\theta}_{s, n}^{(j)}) - \bar{\mathcal{G}}_{s,n})^T,\]</p><p class="math-container">\[   \tag{2} \mathrm{Cov}_q(\mathcal{G}_n, \mathcal{G}_n) \approx \sum_{j=1}^{J_s}w_{s,j} (\mathcal{G}(\hat{\theta}_{s, n}^{(j)}) - \bar{\mathcal{G}}_{s,n})(\mathcal{G}(\hat{\theta}_{s, n}^{(j)}) - \bar{\mathcal{G}}_{s,n})^T,\]</p><p>where the weights at each successful sigma point are scaled up, to preserve the sum of weights,</p><p class="math-container">\[    w_{s,j} = \left(\dfrac{\sum_{i=1}^{2p} w_i}{\sum_{k=1}^{J_s} w_k}\right)w_j.\]</p><p>In equations (1) and (2), the means <span>$\bar{\theta}_{s,n}$</span> and <span>$\bar{\mathcal{G}}_{s,n}$</span> must be modified from the original formulation if the central point <span>$\hat{\theta}^{(0)}=m_n$</span> results in model failure. If this is the case, then an average is taken across the other (successful) ensemble members</p><p class="math-container">\[   \bar{\theta}_{s,n} =
\dfrac{1}{J_s}\sum_{j=1}^{J_s}\hat{\theta}_{s, n}^{(j)}, \qquad   \bar{\mathcal{G}}_{s,n} =
\dfrac{1}{J_s}\sum_{j=1}^{J_s}\mathcal{G}(\hat{\theta}_{s, n}^{(j)}).\]</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../inflation/">« Inflation</a><a class="docs-footer-nextpage" href="../parallel_hpc/">Parallelism and HPC »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Wednesday 30 July 2025 16:19">Wednesday 30 July 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
