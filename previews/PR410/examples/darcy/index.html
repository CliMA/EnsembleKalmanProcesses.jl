<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Darcy flow · EnsembleKalmanProcesses.jl</title><meta name="title" content="Darcy flow · EnsembleKalmanProcesses.jl"/><meta property="og:title" content="Darcy flow · EnsembleKalmanProcesses.jl"/><meta property="twitter:title" content="Darcy flow · EnsembleKalmanProcesses.jl"/><meta name="description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="og:description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="twitter:description" content="Documentation for EnsembleKalmanProcesses.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="EnsembleKalmanProcesses.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">EnsembleKalmanProcesses.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation_instructions/">Installation instructions</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../literated/sinusoid_example/">Simple example</a></li><li><a class="tocitem" href="../Cloudy_example/">Cloudy</a></li><li><a class="tocitem" href="../lorenz_example/">Lorenz</a></li><li><a class="tocitem" href="../../literated/loss_minimization/">Minimization Loss</a></li><li><a class="tocitem" href="../../literated/loss_minimization_sparse_eki/">Sparse Minimization Loss</a></li><li><a class="tocitem" href="../../literated/aerosol_activation/">Aerosol activation</a></li><li class="is-active"><a class="tocitem" href>Darcy flow</a><ul class="internal"><li><a class="tocitem" href="#Walkthrough-of-the-code"><span>Walkthrough of the code</span></a></li><li><a class="tocitem" href="#Inversion-results"><span>Inversion results</span></a></li></ul></li><li><a class="tocitem" href="../sinusoid_example_toml/">TOML interface</a></li><li><a class="tocitem" href="../ClimateMachine_example/">HPC interfacing example: ClimateMachine</a></li><li><a class="tocitem" href="../template_example/">Template</a></li></ul></li><li><a class="tocitem" href="../../defaults/">List of default configurations</a></li><li><a class="tocitem" href="../../ensemble_kalman_inversion/">Ensemble Kalman Inversion</a></li><li><a class="tocitem" href="../../ensemble_kalman_sampler/">Ensemble Kalman Sampler</a></li><li><a class="tocitem" href="../../unscented_kalman_inversion/">Unscented Kalman Inversion</a></li><li><a class="tocitem" href="../../learning_rate_scheduler/">Learning rate schedulers</a></li><li><a class="tocitem" href="../../parameter_distributions/">Prior distributions</a></li><li><a class="tocitem" href="../../observations/">Observations and Minibatching</a></li><li><a class="tocitem" href="../../localization/">Localization and SEC</a></li><li><a class="tocitem" href="../../inflation/">Inflation</a></li><li><a class="tocitem" href="../../parallel_hpc/">Parallelism and HPC</a></li><li><a class="tocitem" href="../../internal_data_representation/">Internal data representation</a></li><li><a class="tocitem" href="../../troubleshooting/">Troubleshooting</a></li><li><input class="collapse-toggle" id="menuitem-16" type="checkbox"/><label class="tocitem" for="menuitem-16"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../API/ParameterDistributions/">ParameterDistributions</a></li><li><a class="tocitem" href="../../API/Observations/">Observations</a></li><li><a class="tocitem" href="../../API/DataContainers/">DataContainers</a></li><li><a class="tocitem" href="../../API/EnsembleKalmanProcess/">EnsembleKalmanProcess</a></li><li><a class="tocitem" href="../../API/Inversion/">Inversion</a></li><li><a class="tocitem" href="../../API/Unscented/">Unscented</a></li><li><a class="tocitem" href="../../API/Sampler/">Sampler</a></li><li><a class="tocitem" href="../../API/SparseInversion/">SparseInversion</a></li><li><a class="tocitem" href="../../API/TOMLInterface/">TOML Interface</a></li><li><a class="tocitem" href="../../API/Localizers/">Localizers</a></li></ul></li><li><a class="tocitem" href="../../contributing/">Contributing</a></li><li><a class="tocitem" href="../../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Darcy flow</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Darcy flow</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/main/docs/src/examples/darcy.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Learning-the-permeability-field-in-a-Darcy-flow"><a class="docs-heading-anchor" href="#Learning-the-permeability-field-in-a-Darcy-flow">Learning the permeability field in a Darcy flow</a><a id="Learning-the-permeability-field-in-a-Darcy-flow-1"></a><a class="docs-heading-anchor-permalink" href="#Learning-the-permeability-field-in-a-Darcy-flow" title="Permalink"></a></h1><div class="admonition is-info"><header class="admonition-header">How do I run this code?</header><div class="admonition-body"><p>The full code is found in the <a href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/tree/main/examples"><code>examples/</code></a> directory of the github repository</p></div></div><p>In this example, we illustrate a simple function learning problem. We are presented with an unknown field that is discretized with a finite-dimensional approximation (e.g. spatial discretization). When learning this field, if one represents each pointwise value at a gridpoint as a parameter, increasing the spatial resolution leads to increasingly high dimensional learning problems, thus giving poor computational scaling and increasingly ill-posed inverse problems from fixed data. If instead, we treat the approximation as a discretized function living in a function space, then one can learn coefficients of a basis of this function space. Since it is commonly the case that functions have relatively low effective dimension in this space, the dependence on the spatial discretization only arises in discretization error, which vanishes as resolution is increased.</p><p>We will solve for an unknown permeability field <span>$\kappa$</span> governing the pressure field of a <a href="https://en.wikipedia.org/wiki/Darcy%27s_law">Darcy flow</a> on a square 2D domain. To learn about the permeability we shall take few pointwise measurements of the solved pressure field within the domain. The forward solver is a simple finite difference scheme taken and modified from code <a href="https://github.com/Zhengyu-Huang/InverseProblems.jl/blob/master/Fluid/Darcy-2D.jl">here</a>.</p><h2 id="Walkthrough-of-the-code"><a class="docs-heading-anchor" href="#Walkthrough-of-the-code">Walkthrough of the code</a><a id="Walkthrough-of-the-code-1"></a><a class="docs-heading-anchor-permalink" href="#Walkthrough-of-the-code" title="Permalink"></a></h2><p>First we load standard packages,</p><pre><code class="language-julia hljs">using LinearAlgebra
using Distributions
using Random
using JLD2</code></pre><p>the package to define the function distributions,</p><pre><code class="language-julia hljs">import GaussianRandomFields # we wrap this so we don&#39;t want to use &quot;using&quot;
const GRF = GaussianRandomFields</code></pre><p>and finally the EKP packages.</p><pre><code class="language-julia hljs">using EnsembleKalmanProcesses
using EnsembleKalmanProcesses.ParameterDistributions
const EKP = EnsembleKalmanProcesses</code></pre><p>We include the forward solver here.</p><pre><code class="language-julia hljs">include(&quot;GModel.jl&quot;)</code></pre><p>We define the spatial domain and discretization,</p><pre><code class="language-julia hljs">rng = Random.MersenneTwister(seed)
dim = 2
N, L = 80, 1.0
pts_per_dim = LinRange(0, L, N)</code></pre><p>To provide a simple test case, we assume that the true function parameter is a particular sample from the function space we set up to define our prior. We choose a value of the truth that doesnt have a vanishingly small probability under the prior defined by a probability distribution over functions; taken to be a family of Gaussian Random Fields (GRF). This function distribution is characterized by a covariance function (Matern) and an appropriate representation (Karhunen-Loeve expansion). The representation is truncated to a finite number of coefficients, the degrees of freedom (<code>dofs</code>), which define the effective dimension of the learning problem that is decoupled from the spatial discretization. Larger <code>dofs</code> may be required to represent multiscale functions, but come at an increased dimension of the parameter space and therefore a typical increase in cost and difficulty of the learning problem. For more details see <a href="https://pieterjanrobbe.github.io/GaussianRandomFields.jl/stable/"><code>GaussianRandomFields.jl</code></a></p><pre><code class="language-julia hljs">smoothness = 2.0
corr_length = 0.5
dofs = 50

grf = GRF.GaussianRandomField(
    GRF.CovarianceFunction(dim, GRF.Matern(smoothness, corr_length)),
    GRF.KarhunenLoeve(dofs),
    pts_per_dim,
    pts_per_dim,
)</code></pre><p>We define a wrapper around the GRF, and as the permeability field must be positive we introduce a domain constraint into the function distribution. </p><pre><code class="language-julia hljs">pkg = GRFJL()
distribution = GaussianRandomFieldInterface(grf, pkg) # our wrapper from EKP
domain_constraint = bounded_below(0) # make κ positive
pd = ParameterDistribution(
    Dict(&quot;distribution&quot; =&gt; distribution, &quot;name&quot; =&gt; &quot;kappa&quot;, &quot;constraint&quot; =&gt; domain_constraint),
) # the fully constrained parameter distribution</code></pre><p>Henceforth, the GRF is interfaced in the same manner as any other parameter distribution with regards to interface. We choose the true value by setting all degrees of freedom <span>$u_{\mathrm{true}} = -1.5$</span>; this choice is arbitrary, upto not having a vanishingly small mass under the prior. We then use the EKP transform function to build the corresponding instance of the <span>$\kappa_{\mathrm{true}}$</span>.</p><pre><code class="language-julia hljs">u_true = -1.5 * ones(dofs,1) # the truth parameter
κ_true = transform_unconstrained_to_constrained(pd, u_true) # builds and constrains the function.
κ_true = reshape(κ_true, N, N)</code></pre><p>We generate the data sample for the truth in a perfect model setting by evaluating the the model here, and observing the pressure field at a few subsampled points in each dimension (here <code>obs_ΔN</code>, samples every 10 points in each dimension, leading to a <span>$7 \times 7$</span> observation grid), and we assume 5% additive observational noise on the measurements.</p><pre><code class="language-julia hljs">obs_ΔN = 10 
darcy = Setup_Param(pts_per_dim, obs_ΔN, κ_true) 
h_2d = solve_Darcy_2D(darcy, κ_true)
y_noiseless = compute_obs(darcy, h_2d)
obs_noise_cov = 0.05^2 * I(length(y_noiseless)) * (maximum(y_noiseless) - minimum(y_noiseless))
truth_sample = vec(y_noiseless + rand(rng, MvNormal(zeros(length(y_noiseless)), obs_noise_cov)))</code></pre><p>Now we set up the Bayesian inversion algorithm. The prior we have already defined to construct our truth</p><pre><code class="language-julia hljs">prior = pd</code></pre><p>We define some algorithm parameters, here we take ensemble members larger than the dimension of the parameter space to ensure a full rank ensemble covariance.</p><pre><code class="language-julia hljs">N_ens = dofs + 2 # number of ensemble members
N_iter = 20 # number of EKI iterations</code></pre><p>We sample the initial ensemble from the prior, and create the EKP object as an EKI algorithm using the <code>Inversion()</code> keyword, we also use the <code>DataMisfitController()</code> learning rate scheduler</p><pre><code class="language-julia hljs">initial_params = construct_initial_ensemble(rng, prior, N_ens) 
ekiobj = EKP.EnsembleKalmanProcess(initial_params, truth_sample, obs_noise_cov, Inversion(), scheduler=DataMisfitController())</code></pre><p>We perform the inversion loop. Remember that within calls to <code>get_ϕ_final</code> the EKP transformations are applied, thus the ensemble that is returned will be the positively-bounded permeability field evaluated at all the discretization points. Each ensemble member is stored as a column and therefore for uses such as plotting one needs to reshape to the desired dimension.</p><pre><code class="language-julia hljs">err = zeros(N_iter)
for i in 1:N_iter
    params_i = get_ϕ_final(prior, ekiobj)
    g_ens = run_G_ensemble(darcy, params_i)
    EKP.update_ensemble!(ekiobj, g_ens)
end</code></pre><h2 id="Inversion-results"><a class="docs-heading-anchor" href="#Inversion-results">Inversion results</a><a id="Inversion-results-1"></a><a class="docs-heading-anchor-permalink" href="#Inversion-results" title="Permalink"></a></h2><p>We plot first the prior ensemble mean and pointwise variance of the permeability field, and also the pressure field solved with the ensemble mean. </p><p><img src="../../assets/darcy_prior.png" alt="Darcy prior"/></p><p>Now we plot the final ensemble mean and pointwise variance of the permeability field, and also the pressure field solved with the ensemble mean.</p><p><img src="../../assets/darcy_final.png" alt="Darcy final"/></p><p>We can compare this with the true permeability and pressure field:</p><p><img src="../../assets/darcy_true.png" alt="Darcy truth"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../literated/aerosol_activation/">« Aerosol activation</a><a class="docs-footer-nextpage" href="../sinusoid_example_toml/">TOML interface »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Wednesday 9 October 2024 18:38">Wednesday 9 October 2024</span>. Using Julia version 1.11.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
