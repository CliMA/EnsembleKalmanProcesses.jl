<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Ensemble Kalman Sampler · EnsembleKalmanProcesses.jl</title><meta name="title" content="Ensemble Kalman Sampler · EnsembleKalmanProcesses.jl"/><meta property="og:title" content="Ensemble Kalman Sampler · EnsembleKalmanProcesses.jl"/><meta property="twitter:title" content="Ensemble Kalman Sampler · EnsembleKalmanProcesses.jl"/><meta name="description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="og:description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="twitter:description" content="Documentation for EnsembleKalmanProcesses.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="EnsembleKalmanProcesses.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">EnsembleKalmanProcesses.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation instructions</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../literated/sinusoid_example/">Simple example</a></li><li><a class="tocitem" href="../examples/Cloudy_example/">Cloudy</a></li><li><a class="tocitem" href="../examples/lorenz_example/">Lorenz</a></li><li><a class="tocitem" href="../literated/loss_minimization/">Minimization Loss</a></li><li><a class="tocitem" href="../literated/loss_minimization_sparse_eki/">Sparse Minimization Loss</a></li><li><a class="tocitem" href="../literated/aerosol_activation/">Aerosol activation</a></li><li><a class="tocitem" href="../examples/darcy/">Darcy flow</a></li><li><a class="tocitem" href="../examples/sinusoid_example_toml/">TOML interface</a></li><li><a class="tocitem" href="../examples/ClimateMachine_example/">HPC interfacing example: ClimateMachine</a></li><li><a class="tocitem" href="../examples/template_example/">Template</a></li></ul></li><li><a class="tocitem" href="../defaults/">List of default configurations</a></li><li><a class="tocitem" href="../ensemble_kalman_inversion/">Ensemble Kalman Inversion</a></li><li class="is-active"><a class="tocitem" href>Ensemble Kalman Sampler</a></li><li><a class="tocitem" href="../unscented_kalman_inversion/">Unscented Kalman Inversion</a></li><li><a class="tocitem" href="../learning_rate_scheduler/">Learning rate schedulers</a></li><li><a class="tocitem" href="../parameter_distributions/">Prior distributions</a></li><li><a class="tocitem" href="../observations/">Observations and Minibatching</a></li><li><a class="tocitem" href="../localization/">Localization and SEC</a></li><li><a class="tocitem" href="../inflation/">Inflation</a></li><li><a class="tocitem" href="../parallel_hpc/">Parallelism and HPC</a></li><li><a class="tocitem" href="../internal_data_representation/">Internal data representation</a></li><li><a class="tocitem" href="../troubleshooting/">Troubleshooting</a></li><li><input class="collapse-toggle" id="menuitem-16" type="checkbox"/><label class="tocitem" for="menuitem-16"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../API/ParameterDistributions/">ParameterDistributions</a></li><li><a class="tocitem" href="../API/Observations/">Observations</a></li><li><a class="tocitem" href="../API/DataContainers/">DataContainers</a></li><li><a class="tocitem" href="../API/EnsembleKalmanProcess/">EnsembleKalmanProcess</a></li><li><a class="tocitem" href="../API/Inversion/">Inversion</a></li><li><a class="tocitem" href="../API/Unscented/">Unscented</a></li><li><a class="tocitem" href="../API/Sampler/">Sampler</a></li><li><a class="tocitem" href="../API/SparseInversion/">SparseInversion</a></li><li><a class="tocitem" href="../API/TOMLInterface/">TOML Interface</a></li><li><a class="tocitem" href="../API/Localizers/">Localizers</a></li></ul></li><li><a class="tocitem" href="../contributing/">Contributing</a></li><li><a class="tocitem" href="../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Ensemble Kalman Sampler</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Ensemble Kalman Sampler</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/main/docs/src/ensemble_kalman_sampler.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="eks"><a class="docs-heading-anchor" href="#eks">Ensemble Kalman Sampling</a><a id="eks-1"></a><a class="docs-heading-anchor-permalink" href="#eks" title="Permalink"></a></h1><h3 id="What-Is-It-and-What-Does-It-Do?"><a class="docs-heading-anchor" href="#What-Is-It-and-What-Does-It-Do?">What Is It and What Does It Do?</a><a id="What-Is-It-and-What-Does-It-Do?-1"></a><a class="docs-heading-anchor-permalink" href="#What-Is-It-and-What-Does-It-Do?" title="Permalink"></a></h3><p>The Ensemble Kalman Sampler (EKS) (<a href="https://doi.org/10.1137/19M1251655">Garbuno-Inigo et al, 2020</a>, <a href="https://doi.org/10.1016/j.jcp.2020.109716">Cleary et al, 2020</a>, <a href="https://doi.org/10.1137/19M1304891">Garbuno-Inigo et al, 2020</a>) is a derivative-free tool for approximate Bayesian inference. It does so by approximately sampling from the posterior distribution. That is, EKS provides both point estimation (through the mean of the final ensemble) and uncertainty quantification (through the covariance of the final ensemble), this is in contrast to EKI, which only provides point estimation.</p><p>The EKS is an interacting particle system in stochastic differential equation form, and it is based on a dynamic which transforms an arbitrary initial probability distribution into an approximation of the desired posterior distribution over an infinite time horizon – see <a href="https://doi.org/10.1137/19M1251655">Garbuno-Inigo et al, 2020</a>, for a comprehensive description of the method. While there are noisy variants of the standard EKI, EKS differs from them in its noise structure (as its noise is added in parameter space, not in  data space), and its update rule explicitly accounts for the prior (rather than having it enter through initialization). The EKS algorithm can be understood as well as an affine invariant system of interacting particles (<a href="https://doi.org/10.1137/19M1304891">Garbuno-Inigo et al, 2020</a>) for which a finite-sample correction is introduced to overcome its computational finite-sample implementation. This finite-sample corrected version of EKS is also known as the affine invariant Langevin dynamics (ALDI).</p><p>Perhaps as expected, the approximate posterior characterization through EKS needs more iterations, and thus more forward model evaluations, than EKI to converge to a suitable solution. This is because of the discrete-time implementation of the EKS diffusion process and the need to maintain a stable interacting particle system. However, the posterior approximation through EKS is obtained with far less computational effort than a typical Markov Chain Monte Carlo (MCMC) like Metropolis-Hastings.</p><h3 id="Problem-Formulation"><a class="docs-heading-anchor" href="#Problem-Formulation">Problem Formulation</a><a id="Problem-Formulation-1"></a><a class="docs-heading-anchor-permalink" href="#Problem-Formulation" title="Permalink"></a></h3><p>The data <span>$y$</span> and parameter vector <span>$\theta$</span> are assumed to be related according to:</p><p class="math-container">\[    y = \mathcal{G}(\theta) + \eta \,,\]</p><p>where <span>$\mathcal{G}:  \mathbb{R}^p \rightarrow \mathbb{R}^d$</span> denotes the forward map, <span>$y \in \mathbb{R}^d$</span> is the vector of observations, and <span>$\eta$</span> is the observational noise, which is assumed to be drawn from a <span>$d$</span>-dimensional Gaussian with distribution <span>$\mathcal{N}(0, \Gamma_y)$</span>. The objective of the inverse problem is to compute the unknown parameters <span>$\theta$</span> given the observations <span>$y$</span>, the known forward map <span>$\mathcal{G}$</span>, and noise characteristics <span>$\eta$</span> of the process.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>To obtain Bayesian characterization for the posterior from EKS, the user must specify a Gaussian prior distribution. See <a href="../parameter_distributions/#parameter-distributions">Prior distributions</a> to see how one can apply flexible constraints while maintaining Gaussian priors. </p></div></div><h3 id="Ensemble-Kalman-Sampling-Algorithm"><a class="docs-heading-anchor" href="#Ensemble-Kalman-Sampling-Algorithm">Ensemble Kalman Sampling Algorithm</a><a id="Ensemble-Kalman-Sampling-Algorithm-1"></a><a class="docs-heading-anchor-permalink" href="#Ensemble-Kalman-Sampling-Algorithm" title="Permalink"></a></h3><p>The EKS is based on the following update equation for the parameter vector <span>$\theta^{(j)}_n$</span> of ensemble member <span>$j$</span> at the <span>$n$</span>-iteration:</p><p class="math-container">\[\begin{aligned}
\theta_{n+1}^{(*, j)} &amp;= \theta_{n}^{(j)} - \dfrac{\Delta t_n}{J}\sum_{k=1}^J\langle \mathcal{G}(\theta_n^{(k)}) - \bar{\mathcal{G}}_n, \Gamma_y^{-1}(\mathcal{G}(\theta_n^{(j)}) - y) \rangle \theta_{n}^{(k)} + \frac{d+1}{J} \left(\theta_{n}^{(j)} - \bar \theta_n \right) - \Delta t_n \mathsf{C}(\Theta_n) \Gamma_{\theta}^{-1} \theta_{n + 1}^{(*, j)} \,, \\
\theta_{n + 1}^{j} &amp;= \theta_{n+1}^{(*, j)} + \sqrt{2 \Delta t_n \mathsf{C}(\Theta_n)} \xi_n^{j} \,,
\end{aligned}\]</p><p>where the subscript <span>$n=1, \dots, N_{\text{it}}$</span> indicates the iteration, <span>$J$</span> is the ensemble size (i.e., the number of particles in the ensemble), <span>$\Delta t_n$</span> is an internal adaptive time step (thus no need for the user to specify), <span>$\Gamma_{\theta}$</span> is the prior covariance, and <span>$\xi_n^{(j)} \sim \mathcal{N}(0, \mathrm{I}_p)$</span>. <span>$\bar{\mathcal{G}}_n$</span> is the ensemble mean of the forward map <span>$\mathcal{G}(\theta)$</span>,</p><p class="math-container">\[\bar{\mathcal{G}}_n = \dfrac{1}{J}\sum_{k=1}^J\mathcal{G}(\theta_n^{(k)})\,.\]</p><p>The <span>$p \times p$</span> matrix <span>$\mathsf{C}(\Theta_n)$</span>, where <span>$\Theta_n = \left\{\theta^{(j)}_n\right\}_{j=1}^{J}$</span> is the set of all ensemble particles in the <span>$n$</span>-th iteration, denotes the empirical covariance between particles</p><p class="math-container">\[\mathsf{C}(\Theta_n) = \frac{1}{J} \sum_{k=1}^J (\theta^{(k)}_n - \bar{\theta}_n) \otimes (\theta^{(k)}_n - \bar{\theta}_n)\,,\]</p><p>where <span>$\bar{\theta}_n$</span> is the ensemble mean of the particles,</p><p class="math-container">\[\bar{\theta}_n = \dfrac{1}{J}\sum_{k=1}^J\theta^{(k)}_n \,.\]</p><h3 id="Constructing-the-Forward-Map"><a class="docs-heading-anchor" href="#Constructing-the-Forward-Map">Constructing the Forward Map</a><a id="Constructing-the-Forward-Map-1"></a><a class="docs-heading-anchor-permalink" href="#Constructing-the-Forward-Map" title="Permalink"></a></h3><p>At the core of the forward map <span>$\mathcal{G}$</span> is the dynamical model <span>$\Psi:\mathbb{R}^p \rightarrow \mathbb{R}^o$</span> (running <span>$\Psi$</span> is usually where the computational heavy-lifting is done), but the map <span>$\mathcal{G}$</span> may include additional components such as a transformation of the (unbounded) parameters <span>$\theta$</span> to a constrained domain the dynamical model can work with, or some post-processing of the output of <span>$\Psi$</span> to generate the observations. For example, <span>$\mathcal{G}$</span> may take the following form:</p><p class="math-container">\[\mathcal{G} = \mathcal{H} \circ \Psi \circ \mathcal{T}^{-1},\]</p><p>where <span>$\mathcal{H}:\mathbb{R}^o \rightarrow \mathbb{R}^d$</span> is the observation map and <span>$\mathcal{T}$</span> is the transformation from the constrained to the unconstrained parameter space, such that <span>$\mathcal{T}(\phi)=\theta$</span>. A family of standard transformations and their inverses are available in the <code>ParameterDistributions</code> module.</p><h3 id="How-to-Construct-an-Ensemble-Kalman-Sampler"><a class="docs-heading-anchor" href="#How-to-Construct-an-Ensemble-Kalman-Sampler">How to Construct an Ensemble Kalman Sampler</a><a id="How-to-Construct-an-Ensemble-Kalman-Sampler-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-Construct-an-Ensemble-Kalman-Sampler" title="Permalink"></a></h3><p>An EKS object can be created using the <code>EnsembleKalmanProcess</code> constructor by specifying the <code>Sampler</code> type. The constructor takes two arguments, the prior mean <code>prior_mean</code> and the prior covariance <code>prior_cov</code>.</p><p>Creating an EKS object requires as arguments:</p><ol><li><p>An initial parameter ensemble – an array of size <code>p × N_ens</code>, where <code>N_ens</code> is the  ensemble size;</p></li><li><p>The mean value of the observed data – a vector of length <code>d</code>;</p></li><li><p>The covariance matrix of the observational noise – an array of size <code>d × d</code>;</p></li><li><p>The <code>Sampler(prior_mean, prior_cov)</code> process type, with the mean (a vector of length <code>p</code>) and the covariance (an array of size <code>p x p</code>) of the parameter&#39;s prior distribution.</p></li></ol><p>The following example shows how an EKS object is instantiated. An observation (<code>y</code>) and the covariance of the observational noise (<code>obs_cov</code>) are assumed to be defined previously in the code.</p><pre><code class="language-julia hljs">using EnsembleKalmanProcesses
using EnsembleKalmanProcesses.ParameterDistributions  # required to create the prior

# Construct prior (see `ParameterDistributions.jl` docs)
prior = ParameterDistribution(...)
prior_mean = mean(prior)
prior_cov = cov(prior)

# Construct initial ensemble
N_ens = 50  # ensemble size
initial_ensemble = construct_initial_ensemble(prior, N_ens)

# Construct ensemble Kalman process
eks_process = Sampler(prior_mean, prior_cov)
eksobj = EnsembleKalmanProcess(initial_ensemble, y, obs_noise_cov, eks_process)</code></pre><h3 id="Updating-the-ensemble"><a class="docs-heading-anchor" href="#Updating-the-ensemble">Updating the ensemble</a><a id="Updating-the-ensemble-1"></a><a class="docs-heading-anchor-permalink" href="#Updating-the-ensemble" title="Permalink"></a></h3><p>Once the EKS object <code>eksobj</code> has been initialized, the initial ensemble of particles is iteratively updated by the <code>update_ensemble!</code> function, which takes as arguments the <code>eksobj</code> and the evaluations of the forward model at each member of the current ensemble. In the following example, the forward map <code>G</code> maps a parameter to the corresponding data – this is done for each parameter in the ensemble, such that the resulting <code>g_ens</code> is of size <code>d x N_ens</code>. The <code>update_ensemble!</code> function then stores the updated ensemble as well as the evaluations of the forward map in <code>eksobj</code>.</p><p>A typical use of the <code>update_ensemble!</code> function given the EKS object <code>eksobj</code>, the dynamical model <code>Ψ</code>, and the observation map <code>H</code> (the latter two are assumed to be defined elsewhere, e.g. in a separate module)  may look as follows:</p><pre><code class="language-julia hljs"># Given:
# Ψ (some black box simulator)
# H (some observation of the simulator output)
# prior (prior distribution and parameter constraints)

N_iter = 100 # Number of iterations

for n in 1:N_iter
    ϕ_n = get_ϕ_final(prior, eksobj) # Get current ensemble in constrained &quot;ϕ&quot;-space
    G_n = [H(Ψ(ϕ_n[:, i])) for i in 1:J]  # Evaluate forward map
    g_ens = hcat(G_n...)  # Reformat into `d x N_ens` matrix
    update_ensemble!(eksobj, g_ens) # Update ensemble
end</code></pre><h3 id="Solution"><a class="docs-heading-anchor" href="#Solution">Solution</a><a id="Solution-1"></a><a class="docs-heading-anchor-permalink" href="#Solution" title="Permalink"></a></h3><p>The solution of the EKS algorithm is an approximate Gaussian distribution whose mean (<code>θ_post</code>) and covariance (<code>Γ_post</code>) can be extracted from the &#39;&#39;final ensemble&#39;&#39; (i.e., after the last iteration). The sample mean of the last ensemble is also the &quot;optimal&quot; parameter (<code>θ_optim</code>) for the given calibration problem. These statistics can be accessed as follows:</p><pre><code class="language-julia hljs"># mean of the Gaussian distribution, the optimal parameter in computational θ-space
θ_post = get_u_mean_final(eksobj)
# (empirical) covariance of the Gaussian distribution in computational θ-space
Γ_post = get_u_cov_final(eksobj)</code></pre><p>To obtain samples of this approximate posterior in the constrained space, we first sample the distribution, then transform using the constraints contained within the prior </p><pre><code class="language-julia hljs">using Random, Distributions

ten_post_samples = rand(MvNormal(θ_post,Γ_post), 10)
ten_post_samples_phys = transform_unconstrained_to_constrained(prior, ten_post_samples) # the optimal physical parameter value</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../ensemble_kalman_inversion/">« Ensemble Kalman Inversion</a><a class="docs-footer-nextpage" href="../unscented_kalman_inversion/">Unscented Kalman Inversion »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Wednesday 9 October 2024 18:38">Wednesday 9 October 2024</span>. Using Julia version 1.11.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
