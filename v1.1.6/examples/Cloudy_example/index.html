<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Cloudy · EnsembleKalmanProcesses.jl</title><meta name="title" content="Cloudy · EnsembleKalmanProcesses.jl"/><meta property="og:title" content="Cloudy · EnsembleKalmanProcesses.jl"/><meta property="twitter:title" content="Cloudy · EnsembleKalmanProcesses.jl"/><meta name="description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="og:description" content="Documentation for EnsembleKalmanProcesses.jl."/><meta property="twitter:description" content="Documentation for EnsembleKalmanProcesses.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="EnsembleKalmanProcesses.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">EnsembleKalmanProcesses.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation_instructions/">Installation instructions</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../literated/sinusoid_example/">Simple example</a></li><li class="is-active"><a class="tocitem" href>Cloudy</a></li><li><a class="tocitem" href="../lorenz_example/">Lorenz</a></li><li><a class="tocitem" href="../../literated/loss_minimization/">Minimization Loss</a></li><li><a class="tocitem" href="../../literated/loss_minimization_sparse_eki/">Sparse Minimization Loss</a></li><li><a class="tocitem" href="../../literated/aerosol_activation/">Aerosol activation</a></li><li><a class="tocitem" href="../darcy/">Darcy flow</a></li><li><a class="tocitem" href="../sinusoid_example_toml/">TOML interface</a></li><li><a class="tocitem" href="../ClimateMachine_example/">HPC interfacing example: ClimateMachine</a></li><li><a class="tocitem" href="../template_example/">Template</a></li></ul></li><li><a class="tocitem" href="../../ensemble_kalman_inversion/">Ensemble Kalman Inversion</a></li><li><a class="tocitem" href="../../ensemble_kalman_sampler/">Ensemble Kalman Sampler</a></li><li><a class="tocitem" href="../../unscented_kalman_inversion/">Unscented Kalman Inversion</a></li><li><a class="tocitem" href="../../learning_rate_scheduler/">Learning rate schedulers</a></li><li><a class="tocitem" href="../../parameter_distributions/">Prior distributions</a></li><li><a class="tocitem" href="../../observations/">Observations and Minibatching</a></li><li><a class="tocitem" href="../../localization/">Localization and SEC</a></li><li><a class="tocitem" href="../../inflation/">Inflation</a></li><li><a class="tocitem" href="../../parallel_hpc/">Parallelism and HPC</a></li><li><a class="tocitem" href="../../internal_data_representation/">Internal data representation</a></li><li><a class="tocitem" href="../../troubleshooting/">Troubleshooting</a></li><li><input class="collapse-toggle" id="menuitem-15" type="checkbox"/><label class="tocitem" for="menuitem-15"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../API/ParameterDistributions/">ParameterDistributions</a></li><li><a class="tocitem" href="../../API/Observations/">Observations</a></li><li><a class="tocitem" href="../../API/DataContainers/">DataContainers</a></li><li><a class="tocitem" href="../../API/EnsembleKalmanProcess/">EnsembleKalmanProcess</a></li><li><a class="tocitem" href="../../API/Inversion/">Inversion</a></li><li><a class="tocitem" href="../../API/Unscented/">Unscented</a></li><li><a class="tocitem" href="../../API/Sampler/">Sampler</a></li><li><a class="tocitem" href="../../API/SparseInversion/">SparseInversion</a></li><li><a class="tocitem" href="../../API/TOMLInterface/">TOML Interface</a></li><li><a class="tocitem" href="../../API/Localizers/">Localizers</a></li></ul></li><li><a class="tocitem" href="../../contributing/">Contributing</a></li><li><a class="tocitem" href="../../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Cloudy</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Cloudy</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/main/docs/src/examples/Cloudy_example.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Cloudy-example"><a class="docs-heading-anchor" href="#Cloudy-example">Cloudy Example</a><a id="Cloudy-example-1"></a><a class="docs-heading-anchor-permalink" href="#Cloudy-example" title="Permalink"></a></h1><h3 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h3><p>This example is based on Cloudy, a microphysics model that simulates how cloud droplets collide and coalesce into larger drops. Collision-coalescence is a crucial process for the formation of rain. </p><p>Cloudy is initialized with a mass distribution of the cloud droplets; this distribution is then evolved in time, with more and more droplets colliding and combining into bigger drops according to the droplet-droplet interactions specified by a collision-coalescence kernel. The evolution is completely determined by the shape of the initial distribution and the form of the kernel.</p><p>This example shows how ensemble Kalman methods can be used to learn the parameters of the initial cloud droplet mass distribution from observations of the moments of that mass distribution at a later time. The collision-coalescence kernel is assumed to be known, but one could also learn the parameters of the kernel instead of the parameters of the droplet distribution (or both).</p><p>Cloudy is used here in a &quot;perfect model&quot; (aka &quot;known truth&quot;) setting, which means that the &quot;observations&quot; are generated by Cloudy itself, by running it with the true parameter values. In more realistic applications, this parameter estimation procedure will use actual measurements of cloud properties to obtain an estimated droplet mass distribution at a previous time.</p><h3 id="Prerequisites"><a class="docs-heading-anchor" href="#Prerequisites">Prerequisites</a><a id="Prerequisites-1"></a><a class="docs-heading-anchor-permalink" href="#Prerequisites" title="Permalink"></a></h3><p>In order to run this example, you need to install <code>Cloudy.jl</code> (the &quot;#master&quot; lets you install the current master branch):</p><pre><code class="nohighlight hljs">pkg &gt; add Cloudy#master</code></pre><h3 id="Structure"><a class="docs-heading-anchor" href="#Structure">Structure</a><a id="Structure-1"></a><a class="docs-heading-anchor-permalink" href="#Structure" title="Permalink"></a></h3><p>The file <code>Cloudy_example_eki.jl</code> sets up the inverse problem and solves it using <a href="https://clima.github.io/EnsembleKalmanProcesses.jl/dev/ensemble_kalman_inversion/">ensemble Kalman inversion</a>, and the file <code>Cloudy_example_uki.jl</code> does the same using unscented Kalman inversion. The file <code>DynamicalModel.jl</code> provides the functionality to run the dynamical model <span>$\Psi$</span>, which in this example is Cloudy.</p><h3 id="Running-the-Example"><a class="docs-heading-anchor" href="#Running-the-Example">Running the Example</a><a id="Running-the-Example-1"></a><a class="docs-heading-anchor-permalink" href="#Running-the-Example" title="Permalink"></a></h3><p>Once Cloudy is installed, the examples can be run from the julia REPL:</p><pre><code class="language-julia hljs"># Solve inverse problem using ensemble Kalman inversion
include(&quot;Cloudy_example_eki.jl&quot;)</code></pre><p>or</p><pre><code class="language-julia hljs"># Solve inverse problem using unscented Kalman inversion
include(&quot;Cloudy_example_uki.jl&quot;)</code></pre><h3 id="What-Does-Cloudy-Do?"><a class="docs-heading-anchor" href="#What-Does-Cloudy-Do?">What Does Cloudy Do?</a><a id="What-Does-Cloudy-Do?-1"></a><a class="docs-heading-anchor-permalink" href="#What-Does-Cloudy-Do?" title="Permalink"></a></h3><p>The mathematical starting point of <a href="https://github.com/CliMA/Cloudy.jl.git">Cloudy</a> is the stochastic collection equation (SCE; sometimes also called <a href="https://en.wikipedia.org/wiki/Smoluchowski_coagulation_equation#:~:text=In%20statistical%20physics%2C%20the%20Smoluchowski,size%20x%20at%20time%20t.">Smoluchowski equation</a> after Marian Smoluchowski), which describes the time rate of change of <span>$f = f(m, t)$</span>, the mass distribution function of liquid water droplets, due to the process of collision and coalescence. The distribution function <span>$f$</span> depends on droplet mass <span>$m$</span> and time <span>$t$</span> and is defined such that <span>$f(m) \text{ d}m$</span> denotes the number of droplets with masses in the interval <span>$[m, m + dm]$</span> per unit volume. </p><p>The stochastic collection equation is an integro-differential equation that can be written as </p><p class="math-container">\[    \frac{\partial f(m, t)}{\partial t} = \frac{1}{2} \int_{m&#39;=0}^{\infty} f(m&#39;, t) f(m-m&#39;, t)  \mathcal{C}(m&#39;, m-m&#39;)\text{d}m&#39; - f(m, t) \int_{m&#39;=0}^\infty f(m&#39;, t)\mathcal{C}(m, m&#39;) \text{d}m&#39;, \]</p><p>where <span>$\mathcal{C}(m&#39;, m&#39;&#39;)$</span> is the collision-coalescence kernel, which  encapsulates the physics of droplet-droplet interactions – it describes the rate at which two drops of masses <span>$m&#39;$</span> and <span>$m&#39;&#39;$</span> come into contact and coalesce into a drop of mass <span>$m&#39; + m&#39;&#39;$</span>. The first term on the right-hand side of the SCE describes the rate of increase of the number of drops having a mass <span>$m$</span> due to collision and coalescence of drops of masses <span>$m&#39;$</span> and <span>$m-m&#39;$</span> (where the factor <span>$\frac{1}{2}$</span> avoids double counting), while the second term describes the rate of reduction of drops of mass <span>$m$</span> due to collision and coalescence of drops having a mass <span>$m$</span> with other drops. </p><p>We can rewrite the SCE in terms of the moments <span>$M_k$</span> of <span>$f$</span>, which are the prognostic variables in Cloudy. They are defined by</p><p class="math-container">\[    M_k = \int_0^\infty m^k f(m, t) \text{d}m\]</p><p>The time rate of change of the k-th moment of <span>$f$</span> is obtained by multiplying the SCE by <span>$m^k$</span> and integrating over the entire range of droplet masses (from <span>$m=0$</span> to <span>$\infty$</span>), which yields</p><p class="math-container">\[    \frac{\partial M_k(t)}{\partial t} = \frac{1}{2}\int_0^\infty \left((m+m&#39;)^k - m^k - {m&#39;}^k\right) \mathcal{C}(m, m&#39;)f(m, t)f(m&#39;, t) \, \text{d}m\, \text{d}m&#39; ~~~~~~~~ (1)\]</p><p>In this example, the kernel is set to be constant – <span>$\mathcal{C}(m&#39;, m&#39;&#39;) = B = \text{const}$</span> – and the cloud droplet mass distribution is assumed to be a <span>$\text{Gamma}(k_t, \theta_t)$</span> distribution, scaled by a factor <span>$N_{0,t}$</span> which denotes the droplet number concentration:</p><p class="math-container">\[f(m, t) = \frac{N_{0,t}}{\Gamma(k_t)\theta_t^k} m^{k_t-1} \exp{(-m/\theta_t)}\]</p><p>The parameter vector <span>$\phi_t= [N_{0,t}, k_t, \theta_t]$</span> changes over time (as indicated by the subscript <span>$t$</span>), as the shape of the distribution evolves. In fact, there is a priori no reason to assume that the distribution would retain its Gamma shape over time, but this is a common assumption that is made in order to solve the closure problem (without this assumption, one would have to keep track of infinitely many moments of the mass distribution in order to uniquely identify the distribution <span>$f$</span> at each time step, which is obviously not practicable).</p><p>For Gamma mass distribution functions, specifying the first three moments (<span>$M_0$</span>, <span>$M_1$</span>, and <span>$M_2$</span>) is sufficient to uniquely determine the parameter vector <span>$\phi_t$</span>, hence Cloudy solves equation (1) for <span>$k = 0, 1, 2$</span>. This mapping of the parameters of the initial cloud droplet mass distribution to the (zeroth-, first-, and second-order) moments of the distribution at a specified end time is done by <code>DynamicalModel.jl</code>.</p><h3 id="Setting-up-the-Inverse-Problem"><a class="docs-heading-anchor" href="#Setting-up-the-Inverse-Problem">Setting up the Inverse Problem</a><a id="Setting-up-the-Inverse-Problem-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-up-the-Inverse-Problem" title="Permalink"></a></h3><p>The goal is to learn the distribution  parameters at time <span>$t = 0$</span>, <span>$\phi_0 = [N_{0,0}, k_0, \theta_0]$</span>, from observations <span>$y = [M_0(t_{end}), M_1(t_{end}), M_2(t_{end})]$</span> of the zeroth-, first-, and second-order moments of the distribution at time <span>$t_{end} &gt; 0$</span> (where <code>t_end = 1.0</code> in this example). This is a known truth experiment, in which the true parameters <span>$\phi_{0, \text{true}}$</span> are defined to be:</p><pre><code class="language-julia hljs">N0_true = 300.0  # number of particles (scaling factor for Gamma distribution)
θ_true = 1.5597  # scale parameter of Gamma distribution
k_true = 0.0817  # shape parameter of Gamma distribution</code></pre><h4 id="Priors"><a class="docs-heading-anchor" href="#Priors">Priors</a><a id="Priors-1"></a><a class="docs-heading-anchor-permalink" href="#Priors" title="Permalink"></a></h4><p>In the code, the priors are constructed as follows:</p><pre><code class="language-julia hljs">par_names = [&quot;N0&quot;, &quot;θ&quot;, &quot;k&quot;]
# constrained_gaussian(&quot;name&quot;, desired_mean, desired_std, lower_bd, upper_bd)
prior_N0 = constrained_gaussian(par_names[1], 400, 300, 0.4 * N0_true, Inf)
prior_θ = constrained_gaussian(par_names[2], 1.0, 5.0, 1e-1, Inf)
prior_k = constrained_gaussian(par_names[3], 0.2, 1.0, 1e-4, Inf)
priors = combine_distributions([prior_N0, prior_θ, prior_k])</code></pre><p>We use the recommended <a href="../../parameter_distributions/#constrained-gaussian"><code>constrained_gaussian</code></a> to add the desired scale and bounds to the prior distribution, in particular we place lower bounds to preserve positivity (and numerical stability). </p><h4 id="Observational-Noise"><a class="docs-heading-anchor" href="#Observational-Noise">Observational Noise</a><a id="Observational-Noise-1"></a><a class="docs-heading-anchor-permalink" href="#Observational-Noise" title="Permalink"></a></h4><p>Cloudy produces output  <span>$y = [M_0(t_{end}), M_1(t_{end}), M_2(t_{end})]$</span>, which is assumed to be related to the parameter vector <span>$\theta$</span> according to:</p><p class="math-container">\[    y = \mathcal{G}(\theta) + \eta,\]</p><p>where <span>$\mathcal{G} = \Psi \circ \mathcal{T}^{-1}$</span> is the forward map, and the observational noise <span>$\eta$</span> is assumed to be drawn from a  3-dimensional  Gaussian  with distribution <span>$\mathcal{N}(0, \Gamma_y)$</span>. In a perfect model setting, the observational noise represents the internal model variability. Since Cloudy is a purely deterministic model, there is no straightforward way of coming up with a covariance <span>$\Gamma_y$</span> for this internal noise. We decide to use a diagonal covariance with the following entries (variances):</p><pre><code class="language-julia hljs">Γy = convert(Array, Diagonal([100.0, 5.0, 30.0]))</code></pre><p>Artificial observations (&quot;truth samples&quot;) are then generated by adding random samples from <span>$\eta$</span> to <code>G_t</code>, the forward map evaluated for the true parameters:</p><pre><code class="language-julia hljs">for i in 1:n_samples
    y_t[:, i] = G_t .+ rand(MvNormal(μ, Γy))
end

truth = Observation(y_t, Γy, data_names)</code></pre><h3 id="Solution-and-Output"><a class="docs-heading-anchor" href="#Solution-and-Output">Solution and Output</a><a id="Solution-and-Output-1"></a><a class="docs-heading-anchor-permalink" href="#Solution-and-Output" title="Permalink"></a></h3><ul><li><p><code>Cloudy_example_eki.jl</code>: The optimal parameter vector determined by the ensemble Kalman inversion is the ensemble mean of the particles after the last iteration, which is printed to standard output. An output directory is created, where two files are stored: <code>parameter_storage_eki.jld2</code> and <code>data_storage_eki.jld2</code>, which contain all parameters and model output from the ensemble Kalman iterations, respectively (both as <code>DataContainers.DataContainer</code> objects). In addition, an animation is produced that shows the evolution of the ensemble of particles over subsequent iterations of the optimization, both in the computational (unconstrained) and physical (constrained) spaces.</p></li><li><p><code>Cloudy_example_uki.jl</code>: In addition to a point estimate of the optimal parameter (which is again given by the ensemble mean of the last iteration and printed to standard output), unscented Kalman inversion also provides a covariance approximation of the posterior distribution. Together, the mean and covariance allow for the reconstruction of a Gaussian approximation of the posterior distribution. The evolution of this Gaussian approximation over subsequent iterations is shown as an animation over the computational (unconstrained) space. All parameters as well as the model output from the unscented Kalman inversion are stored in an output directory, as <code>parameter_storage_uki.jld2</code> and <code>data_storage_uki.jld2</code>. </p></li></ul><h3 id="Playing-Around"><a class="docs-heading-anchor" href="#Playing-Around">Playing Around</a><a id="Playing-Around-1"></a><a class="docs-heading-anchor-permalink" href="#Playing-Around" title="Permalink"></a></h3><p>If you want to play around with the Cloudy examples, you can e.g. change the type or the parameters of the initial cloud droplet mass distribution (see <code>Cloudy.ParticleDistributions</code> for the available distributions), by modifying these lines:</p><pre><code class="language-julia hljs">ϕ_true = [N0_true, θ_true, k_true]
dist_true = ParticleDistributions.GammaPrimitiveParticleDistribution(ϕ_true...)</code></pre><p>(Don&#39;t forget to also change <code>dist_type</code> accordingly).</p><p>You can also experiment with different noise covariances (<code>Γy</code>), priors, vary the number of iterations (<code>N_iter</code>) or ensemble particles (<code>N_ens</code>), etc.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../literated/sinusoid_example/">« Simple example</a><a class="docs-footer-nextpage" href="../lorenz_example/">Lorenz »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Wednesday 31 July 2024 01:50">Wednesday 31 July 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
