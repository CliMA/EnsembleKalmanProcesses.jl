<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Ensemble Kalman Sampler · EnsembleKalmanProcesses.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">EnsembleKalmanProcesses.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../parameter_distributions/">Prior distributions</a></li><li><a class="tocitem" href="../observations/">Observations</a></li><li><a class="tocitem" href="../ensemble_kalman_inversion/">Ensemble Kalman Inversion</a></li><li class="is-active"><a class="tocitem" href>Ensemble Kalman Sampler</a></li><li><a class="tocitem" href="../unscented_kalman_inversion/">Unscented Kalman Inversion</a></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../examples/template_example/">Template Example</a></li><li><a class="tocitem" href="../examples/Cloudy_example/">Cloudy Example</a></li><li><a class="tocitem" href="../examples/lorenz_example/">Lorenz Example</a></li><li><a class="tocitem" href="../examples/ClimateMachine_example/">HPC interfacing example: ClimateMachine</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../API/EnsembleKalmanProcessModule/">EnsembleKalmanProcessModule</a></li><li><a class="tocitem" href="../API/ParameterDistribution/">ParameterDistribution</a></li><li><a class="tocitem" href="../API/Observations/">Observations</a></li><li><a class="tocitem" href="../API/DataStorage/">DataStorage</a></li></ul></li><li><a class="tocitem" href="../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Ensemble Kalman Sampler</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Ensemble Kalman Sampler</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/master/docs/src/ensemble_kalman_sampler.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Ensemble-Kalman-Sampling"><a class="docs-heading-anchor" href="#Ensemble-Kalman-Sampling">Ensemble Kalman Sampling</a><a id="Ensemble-Kalman-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Ensemble-Kalman-Sampling" title="Permalink"></a></h1><h3 id="What-Is-It-and-What-Does-It-Do?"><a class="docs-heading-anchor" href="#What-Is-It-and-What-Does-It-Do?">What Is It and What Does It Do?</a><a id="What-Is-It-and-What-Does-It-Do?-1"></a><a class="docs-heading-anchor-permalink" href="#What-Is-It-and-What-Does-It-Do?" title="Permalink"></a></h3><p>Ensemble Kalman Sampling (<a href="https://arxiv.org/pdf/1903.08866.pdf">Garbuno-Inigo et al, 2019</a>, <a href="https://clima.caltech.edu/files/2020/01/2001.03689.pdf">Cleary et al, 2020</a>) is a derivative-free optimization method that can be used to solve the inverse problem of finding the optimal model parameters given noisy data. In contrast to ensemble Kalman inversion (<a href="http://dx.doi.org/10.1088/0266-5611/29/4/045001">Iglesias et al, 2013</a>), whose iterative updates result in a collapse of the ensemble onto the optimal parameter, the ensemble Kalman sampler generates approximate samples from the Bayesian posterior distribution of the parameter – i.e., it can be used not only for point estimation of the optimal parameter (as provided by the mean of the particles after the last iteration), but also for (approximative) uncertainty quantification (as provided by the covariance of the particles after the last iteration). </p><p>The ensemble Kalman sampler is an interacting particle system in stochastic differential equation form, and it is based on a dynamic which transforms an arbitrary initial distribution into the desired posterior distribution, over an infinite time horizon – see <a href="https://arxiv.org/pdf/1903.08866.pdf">Garbuno-Inigo et al, 2019</a>, for a comprehensive description of the method. The ensemble Kalman sampling algorithm results from the introduction of a judiciously chosen noise to the ensemble Kalman inversion algorithm. Note that while there are also noisy variants of the standard ensemble Kalman inversion, ensemble Kalman sampling differs from them in its noise structure (its noise is added in parameter space, not in  data space), and its update rule explicitly accounts for the prior (rather than having it enter through initialization).</p><h3 id="Problem-Formulation"><a class="docs-heading-anchor" href="#Problem-Formulation">Problem Formulation</a><a id="Problem-Formulation-1"></a><a class="docs-heading-anchor-permalink" href="#Problem-Formulation" title="Permalink"></a></h3><p>The data <span>$y$</span> and parameter vector <span>$\theta$</span> are assumed to be related according to:</p><p class="math-container">\[    y = \mathcal{G}(\theta) + \eta,\]</p><p>where <span>$\mathcal{G}:  \mathbb{R}^p \rightarrow \mathbb{R}^d$</span> denotes the forward map, <span>$y \in \mathbb{R}^d$</span> is the vector of observations, and <span>$\eta$</span> is the observational noise, which is assumed to be drawn from a d-dimensional Gaussian with distribution <span>$\mathcal{N}(0, \Gamma_y)$</span>. The objective of the inverse problem is to compute the unknown parameters <span>$\theta$</span> given the observations <span>$y$</span>, the known forward map <span>$\mathcal{G}$</span>, and noise characteristics <span>$\eta$</span> of the process. </p><h3 id="Ensemble-Kalman-Sampling-Algorithm"><a class="docs-heading-anchor" href="#Ensemble-Kalman-Sampling-Algorithm">Ensemble Kalman Sampling Algorithm</a><a id="Ensemble-Kalman-Sampling-Algorithm-1"></a><a class="docs-heading-anchor-permalink" href="#Ensemble-Kalman-Sampling-Algorithm" title="Permalink"></a></h3><p>The ensemble Kalman sampler is based on the following update equation for the parameter vector <span>$\theta^{(j)}$</span> of ensemble member <span>$j$</span>:</p><p class="math-container">\[\begin{aligned}
\theta_{n+1}^{(*, j)} &amp;= \theta_{n}^{(j)} - \dfrac{\Delta t_n}{J}\sum_{k=1}^J\langle \mathcal{G}(\theta_n^{(k)}) - \bar{\mathcal{G}}_n, \Gamma_y^{-1}(\mathcal{G}(\theta_n^{(j)}) - y) \rangle \theta_{n}^{(k)} - \Delta t_n \mathsf{C}(\Theta_n) \Gamma_{\theta}^{-1} \theta_{n + 1}^{(*, j)} \\
\theta_{n + 1}^{j} &amp;= \theta_{n+1}^{(*, j)} + \sqrt{2 \Delta t_n \mathsf{C}(\Theta_n)} \xi_n^{j}
\end{aligned}\]</p><p>where the subscript <span>$n=1, \dots, N_{it}$</span> indicates the iteration, <span>$J$</span> is the ensemble size (i.e., the number of particles in the ensemble), <span>$\Delta t_n$</span> is an adaptive time step, <span>$\Gamma_{\theta}$</span> is the prior covariance, and <span>$\xi_n^{(j)} \sim \mathcal{N}(0, \mathrm{I})$</span>. <span>$\bar{\mathcal{G}}_n$</span> is the ensemble mean of <span>$\mathcal{G}(\theta)$</span>,</p><p class="math-container">\[\bar{\mathcal{G}}_n = \dfrac{1}{J}\sum_{k=1}^J\mathcal{G}(\theta_n^{(k)})\]</p><p>The <span>$p \times p$</span> matrix <span>$\mathsf{C}(\Theta_n)$</span>, where <span>$\Theta_n = \left\{\theta^{(j)}\right\}_{j=1}^{J}$</span> is the set of all ensemble particles in the nth iteration, denotes the empirical covariance between particles,</p><p class="math-container">\[\mathsf{C}(\Theta_n) = \frac{1}{J} \sum_{k=1}^J (\theta^{(k)} - \bar{\theta}) \otimes (\theta^{(k)} - \bar{\theta}),\]</p><p>where <span>$\bar{\theta}$</span> is the ensemble mean of the particles,</p><p class="math-container">\[\bar{\theta} = \dfrac{1}{J}\sum_{k=1}^J\theta^{(k)}\]</p><h3 id="Constructing-the-Forward-Map"><a class="docs-heading-anchor" href="#Constructing-the-Forward-Map">Constructing the Forward Map</a><a id="Constructing-the-Forward-Map-1"></a><a class="docs-heading-anchor-permalink" href="#Constructing-the-Forward-Map" title="Permalink"></a></h3><p>At the core of the forward map <span>$\mathcal{G}$</span> is the dynamical model <span>$\Psi:\mathbb{R}^p \rightarrow \mathbb{R}^o$</span> (running <span>$\Psi$</span> is usually where the computational heavy-lifting is done), but the map <span>$\mathcal{G}$</span> may include additional components such as a transformation of the (unbounded) parameters <span>$\theta$</span> to a constrained domain the dynamical model can work with, or some post-processing of the output of <span>$\Psi$</span> to generate the observations. For example, <span>$\mathcal{G}$</span> may take the following form:</p><p class="math-container">\[\mathcal{G} = \mathcal{H} \circ \Psi \circ \mathcal{T}^{-1},\]</p><p>where <span>$\mathcal{H}:\mathbb{R}^o \rightarrow \mathbb{R}^d$</span> is the observation map and <span>$\mathcal{T}$</span> is the transformation from the constrained to the unconstrained parameter space, such that <span>$\mathcal{T}(\phi)=\theta$</span>. A family of standard transformations and their inverses are available in the <code>ParameterDistributionStorage</code> module.</p><h3 id="How-to-Construct-an-Ensemble-Kalman-Sampler"><a class="docs-heading-anchor" href="#How-to-Construct-an-Ensemble-Kalman-Sampler">How to Construct an Ensemble Kalman Sampler</a><a id="How-to-Construct-an-Ensemble-Kalman-Sampler-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-Construct-an-Ensemble-Kalman-Sampler" title="Permalink"></a></h3><p>An ensemble Kalman sampling object can be created using the <code>EnsembleKalmanProcess</code> constructor by specifying the <code>Sampler(prior_mean, prior_cov)</code> process type.</p><p>Creating an ensemble Kalman inversion object requires as arguments:</p><ol><li>An initial parameter ensemble – an array of size <code>p × N_ens</code>, where <code>N_ens</code> is the  ensemble size;</li></ol><ol><li>The mean value of the observed data – a vector of length <code>d</code>;</li></ol><ol><li>The covariance matrix of the observational noise – an array of size <code>d × d</code>;</li></ol><ol><li>The <code>Sampler(prior_mean, prior_cov)</code> process type, with the mean (a vector of length <code>p</code>) and the covariance (an array of size <code>p x p</code>) of the parameter&#39;s prior distribution</li></ol><p>The following example shows how an ensemble Kalman sampling object is instantiated. The mean of the observational data (<code>obs_mean</code>) and the covariance of the observational noise (<code>obs_cov</code>) are assumed to be defined previously in the code.</p><pre><code class="language-julia hljs">using EnsembleKalmanProcesses.EnsembleKalmanProcessModule
using EnsembleKalmanProcesses.ParameterDistributionStorage  # required to create the prior

# Construct prior (see `ParameterDistributionStorage.jl` docs)
prior = ParameterDistribution(...)
prior_mean = get_mean(prior)
prior_cov = get_cov(prior)

# Construct initial ensemble
N_ens = 50  # ensemble size
initial_ensemble = construct_initial_ensemble(prior, N_ens) 

# Construct ensemble Kalman process 
eks_process = Sampler(prior_mean, prior_cov)
eks_obj = EnsembleKalmanProcess(initial_ensemble, obs_mean, obs_noise_cov, eks_process)</code></pre><h3 id="Updating-the-ensemble"><a class="docs-heading-anchor" href="#Updating-the-ensemble">Updating the ensemble</a><a id="Updating-the-ensemble-1"></a><a class="docs-heading-anchor-permalink" href="#Updating-the-ensemble" title="Permalink"></a></h3><p>Once the ensemble Kalman sampling object <code>eks_obj</code> has been initialized, the initial ensemble of particles is iteratively updated by the <code>update_ensemble!</code> function, which takes as arguments the <code>eks_obj</code> and the evaluations of the forward model at each member of the current ensemble. In the following example, the forward map <code>G</code> maps a parameter to the corresponding data – this is done for each parameter in the ensemble, such that the resulting <code>g_ens</code> is of size <code>d x N_ens</code>. The <code>update_ensemble!</code> function then stores the updated ensemble as well as the evaluations of the forward map in <code>eks_obj</code>.</p><p>A typical use of the <code>update_ensemble!</code> function given the ensemble Kalman sampler object <code>eks_obj</code>, the dynamical model <code>Ψ</code>, and the observation map <code>H</code> (the latter two are assumed to be defined elsewhere, e.g. in a separate module)  may look as follows:</p><pre><code class="language-julia hljs">N_iter = 10 # Number of iterations

for n in 1:N_iter
    θ_n = get_u_final(eks_obj) # Get current ensemble
    ϕ_n = transform_unconstrained_to_constrained(prior, θ_n) # Transform parameters to physical/constrained space
    G_n = [H(Ψ(ϕ_n[:, i])) for i in 1:J]  # Evaluate forward map
    g_ens = hcat(G_n...)  # Reformat into `d x N_ens` matrix
    update_ensemble!(eks_obj, g_ens) # Update ensemble
end</code></pre><h3 id="Solution"><a class="docs-heading-anchor" href="#Solution">Solution</a><a id="Solution-1"></a><a class="docs-heading-anchor-permalink" href="#Solution" title="Permalink"></a></h3><p>The solution of the ensemble Kalman sampling algorithm is a Gaussian distribution whose mean and covariance can be extracted from the &#39;&#39;last ensemble&#39;&#39; (i.e., the ensemble after the last iteration). The sample mean of the last ensemble is also the &quot;optimal&quot; parameter (<code>θ_optim</code>) for the given calibration problem. These statistics can be accessed as follows: </p><pre><code class="language-julia hljs">using Statistics

# mean of the Gaussian distribution, also the optimal parameter for the calibration problem
θ_optim = mean(get_u_final(eks_obj), dims=2)
# covariance of the Gaussian distribution
sigma = cov(get_u_final(eks_obj), dims=2)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../ensemble_kalman_inversion/">« Ensemble Kalman Inversion</a><a class="docs-footer-nextpage" href="../unscented_kalman_inversion/">Unscented Kalman Inversion »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.5 on <span class="colophon-date" title="Friday 6 August 2021 16:52">Friday 6 August 2021</span>. Using Julia version 1.5.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
