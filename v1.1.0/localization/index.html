<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Localization and SEC · EnsembleKalmanProcesses.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="EnsembleKalmanProcesses.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">EnsembleKalmanProcesses.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation instructions</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../literated/sinusoid_example/">Simple example</a></li><li><a class="tocitem" href="../examples/Cloudy_example/">Cloudy</a></li><li><a class="tocitem" href="../examples/lorenz_example/">Lorenz</a></li><li><a class="tocitem" href="../literated/loss_minimization/">Minimization Loss</a></li><li><a class="tocitem" href="../literated/loss_minimization_sparse_eki/">Sparse Minimization Loss</a></li><li><a class="tocitem" href="../literated/aerosol_activation/">Aerosol activation</a></li><li><a class="tocitem" href="../examples/sinusoid_example_toml/">TOML interface</a></li><li><a class="tocitem" href="../examples/ClimateMachine_example/">HPC interfacing example: ClimateMachine</a></li><li><a class="tocitem" href="../examples/template_example/">Template</a></li></ul></li><li><a class="tocitem" href="../ensemble_kalman_inversion/">Ensemble Kalman Inversion</a></li><li><a class="tocitem" href="../ensemble_kalman_sampler/">Ensemble Kalman Sampler</a></li><li><a class="tocitem" href="../unscented_kalman_inversion/">Unscented Kalman Inversion</a></li><li><a class="tocitem" href="../learning_rate_scheduler/">Learning rate schedulers</a></li><li><a class="tocitem" href="../parameter_distributions/">Prior distributions</a></li><li><a class="tocitem" href="../internal_data_representation/">Internal data representation</a></li><li class="is-active"><a class="tocitem" href>Localization and SEC</a><ul class="internal"><li><a class="tocitem" href="#Enter-Localization"><span>Enter Localization</span></a></li><li><a class="tocitem" href="#Localization-in-EnsembleKalmanProcesses"><span>Localization in EnsembleKalmanProcesses</span></a></li></ul></li><li><a class="tocitem" href="../inflation/">Inflation</a></li><li><a class="tocitem" href="../parallel_hpc/">Parallelism and HPC</a></li><li><a class="tocitem" href="../observations/">Observations</a></li><li><input class="collapse-toggle" id="menuitem-14" type="checkbox"/><label class="tocitem" for="menuitem-14"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../API/ParameterDistributions/">ParameterDistributions</a></li><li><a class="tocitem" href="../API/Observations/">Observations</a></li><li><a class="tocitem" href="../API/DataContainers/">DataContainers</a></li><li><a class="tocitem" href="../API/EnsembleKalmanProcess/">EnsembleKalmanProcess</a></li><li><a class="tocitem" href="../API/Inversion/">Inversion</a></li><li><a class="tocitem" href="../API/Unscented/">Unscented</a></li><li><a class="tocitem" href="../API/Sampler/">Sampler</a></li><li><a class="tocitem" href="../API/SparseInversion/">SparseInversion</a></li><li><a class="tocitem" href="../API/TOMLInterface/">TOML Interface</a></li><li><a class="tocitem" href="../API/Localizers/">Localizers</a></li></ul></li><li><a class="tocitem" href="../contributing/">Contributing</a></li><li><a class="tocitem" href="../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Localization and SEC</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Localization and SEC</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/main/docs/src/localization.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Localization-and-Sampling-Error-Correction-(SEC)"><a class="docs-heading-anchor" href="#Localization-and-Sampling-Error-Correction-(SEC)">Localization and Sampling Error Correction (SEC)</a><a id="Localization-and-Sampling-Error-Correction-(SEC)-1"></a><a class="docs-heading-anchor-permalink" href="#Localization-and-Sampling-Error-Correction-(SEC)" title="Permalink"></a></h1><p>Ensemble Kalman inversion (EKI) seeks to find an optimal parameter vector <span>$\theta \in \mathbb{R}^p$</span> by minimizing the mismatch between some data <span>$y \in \mathbb{R}^d$</span> and the forward model output <span>$\mathcal{G}(\theta) \in \mathbb{R}^d$</span>. Instead of relying on derivatives of the map <span>$\mathcal{G}$</span> with respect to <span>$\theta$</span> to find the optimum, EKI leverages sample covariances <span>$\mathrm{Cov}(\theta, \mathcal{G})$</span> and  <span>$\mathrm{Cov}(\mathcal{G}, \mathcal{G})$</span> diagnosed from an ensemble of <span>$J$</span> particles,</p><p class="math-container">\[   \tag{1}
   \begin{aligned}
         &amp;\mathrm{Cov}(\theta, \mathcal{G}) = \dfrac{1}{J}\sum_{j=1}^{J}
        ({\theta}^{(j)} - {m})(\mathcal{G}(\theta^{(j)}) - \bar{\mathcal{G}})^T, \\

        &amp;\mathrm{Cov}(\mathcal{G}, \mathcal{G}) = \dfrac{1}{J}\sum_{j=1}^{J}
        (\mathcal{G}(\theta^{(j)}) - \bar{\mathcal{G}})(\mathcal{G}(\theta^{(j)}) - \bar{\mathcal{G}})^T, \\
    \end{aligned}\]</p><p>where <span>${m}$</span> and <span>$\bar{\mathcal{G}}$</span> are the ensemble averages of <span>$\theta$</span> and <span>$\mathcal{G}(\theta)$</span>, respectively.</p><p>For models with just a few (<span>$p$</span>) parameters, we can typically afford to use <span>$J &gt; p$</span> ensemble members, such that the sample covariance  <span>$\mathrm{Cov}(\theta, \mathcal{G})$</span> is full rank. Using more ensemble members than the number of model parameters, EKI can in theory probe all dimensions of parameter space to find the optimum parameter vector.</p><p>For models with a lot of parameters (e.g., a deep neural network), computational constraints limit the size of the ensemble to <span>$J &lt; p$</span> or even <span>$J \ll p$</span> members. Due to the characteristics of the EKI update equation, this means that the method can only find the minimum in the <span>$(J-1)$</span>-dimensional space spanned by the initial ensemble, leaving <span>$p-J+1$</span> dimensions unexplored. This is known as the subspace property of EKI. As the dimensional gap <span>$p-J$</span> increases, we can expect the solution of the algorithm to deteriorate.</p><h2 id="Enter-Localization"><a class="docs-heading-anchor" href="#Enter-Localization">Enter Localization</a><a id="Enter-Localization-1"></a><a class="docs-heading-anchor-permalink" href="#Enter-Localization" title="Permalink"></a></h2><p>In algebraic terms, the extent to which we can explore the dimensions of parameter space is roughly given by the rank of the matrices in equation (1). In the case <span>$J &lt; p$</span>, the rank of <span>$\mathrm{Cov}(\theta, \mathcal{G})$</span> is limited to <span>$\mathrm{min}(d, J-1)$</span>. It has been shown that the performance of ensemble Kalman methods with <span>$J &lt; p$</span> can be greatly improved by boosting this rank through an elementwise product with a suitable localization kernel <span>$\Lambda$</span>,</p><p class="math-container">\[\tag{2} \mathrm{rank}(\mathrm{Cov}(\theta, \mathcal{G}) \odot \Lambda) \geq \mathrm{rank}(\mathrm{Cov}(\theta, \mathcal{G})).\]</p><p>Substituting the covariance <span>$\mathrm{Cov}(\theta, \mathcal{G})$</span> by the boosted version defined in the left-hand side of equation (2), EKI is able to break the subspace property and explore additional dimensions in parameter space. Localization is an empirical way of correcting for the sampling error due to a small ensemble size, and so it can also be interpreted as a sampling error correction (SEC) method.</p><h2 id="Localization-in-EnsembleKalmanProcesses"><a class="docs-heading-anchor" href="#Localization-in-EnsembleKalmanProcesses">Localization in EnsembleKalmanProcesses</a><a id="Localization-in-EnsembleKalmanProcesses-1"></a><a class="docs-heading-anchor-permalink" href="#Localization-in-EnsembleKalmanProcesses" title="Permalink"></a></h2><p>A wide variety of localization kernels are available in <code>EnsembleKalmanProcesses.jl</code> under the module <code>Localizers</code>. The <em>optimal</em> localization kernel will depend on the structure of the problem at hand, so the user is encouraged to try different kernels and review their references in the literature.</p><p>In practice, the localization method is chosen at <code>EnsembleKalmanProcess</code> construction time,</p><pre><code class="language-julia hljs">using Distributions
using LinearAlgebra
using EnsembleKalmanProcesses
using EnsembleKalmanProcesses.ParameterDistributions
using EnsembleKalmanProcesses.Localizers
const EKP = EnsembleKalmanProcesses

p = 10; d = 20; J = 6

# Construct initial ensemble
priors = ParameterDistribution[]
for i in 1:p
   push!(priors, ParameterDistribution(Parameterized(Normal(0.0, 0.5)), no_constraint(), string(&quot;u&quot;, i)))
end
prior = combine_distributions(priors)
initial_ensemble = EKP.construct_initial_ensemble(prior, J)

y = 10.0 * rand(d)
Γ = 1.0 * I

# Construct EKP object with localization. Some examples of localization methods:
locs = [Delta(), RBF(1.0), RBF(0.1), BernoulliDropout(0.1), SEC(10.0), SECFisher(), SEC(1.0, 0.1)]
for loc in locs
   ekiobj = EKP.EnsembleKalmanProcess(initial_ensemble, y, Γ, Inversion(); localization_method = loc)
end</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../internal_data_representation/">« Internal data representation</a><a class="docs-footer-nextpage" href="../inflation/">Inflation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Friday 2 June 2023 10:50">Friday 2 June 2023</span>. Using Julia version 1.9.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
